const __vite__mapDeps=(i,m=__vite__mapDeps,d=(m.f||(m.f=["./index2.js","./useConfigStore.js","./index.js"])))=>i.map(i=>d[i]);
import{_ as oe}from"./index.js";import{u as cs,i as ls,b as ds,R as ee,c as de,d as ue,e as ge,p as we,f as Ae,o as F,h as Pe,j as at,s as us,k as ve}from"./useConfigStore.js";const Te=200,Qe={MAX_SESSIONS:3,BACKGROUND_STREAMING_BUFFER:120,ZOMBIE_TIMEOUT:600*1e3},ct=()=>cs.getState?.()?.messageLimit??Te,lt=()=>Math.round(ct()*.6),Wt={MAX_SESSIONS:Qe.MAX_SESSIONS,VIEWPORT_MESSAGES:Math.round(Te*.6),HISTORICAL_MESSAGES:Te,FETCH_BUFFER:20,HISTORY_CHUNK:Te,STREAMING_BUFFER:1/0,BACKGROUND_STREAMING_BUFFER:Qe.BACKGROUND_STREAMING_BUFFER,ZOMBIE_TIMEOUT:Qe.ZOMBIE_TIMEOUT},Mt=()=>{const t=ct(),n=lt();return{...Wt,HISTORICAL_MESSAGES:t,VIEWPORT_MESSAGES:n,HISTORY_CHUNK:t}},gs=Te,We=Wt,ms=gs,fs=()=>{if(typeof window>"u")return"";const t=window.__OPENCHAMBER_DESKTOP_SERVER__?.origin;return t||window.location.origin},q="/api/git";function J(t,n,e){const s=new URL(t,fs());return n&&s.searchParams.set("directory",n),s.toString()}async function ps(t){const n=await fetch(J(`${q}/check`,t));if(!n.ok)throw new Error(`Failed to check git repository: ${n.statusText}`);return(await n.json()).isGitRepository}async function Ss(t){const n=await fetch(J(`${q}/status`,t));if(!n.ok)throw new Error(`Failed to get git status: ${n.statusText}`);return n.json()}async function ys(t){const n=await fetch(J(`${q}/branches`,t));if(!n.ok)throw new Error(`Failed to get branches: ${n.statusText}`);return n.json()}async function hs(t,n){if(!n?.branch)throw new Error("branch is required to delete a branch");const e=await fetch(J(`${q}/branches`,t),{method:"DELETE",headers:{"Content-Type":"application/json"},body:JSON.stringify(n)});if(!e.ok){const s=await e.json().catch(()=>({error:e.statusText}));throw new Error(s.error||"Failed to delete branch")}return e.json()}async function Ms(t,n){if(!n?.branch)throw new Error("branch is required to delete remote branch");const e=await fetch(J(`${q}/remote-branches`,t),{method:"DELETE",headers:{"Content-Type":"application/json"},body:JSON.stringify(n)});if(!e.ok){const s=await e.json().catch(()=>({error:e.statusText}));throw new Error(s.error||"Failed to delete remote branch")}return e.json()}async function ws(t,n){const{base:e,head:s,context:r,zenModel:o}=n;if(!e||!s)throw new Error("base and head are required");const a={base:e,head:s};r?.trim()&&(a.context=r.trim()),o&&(a.zenModel=o);const i=await fetch(J(`${q}/pr-description`,t),{method:"POST",headers:{"Content-Type":"application/json"},body:JSON.stringify(a)});if(!i.ok){const g=await i.json().catch(()=>({error:i.statusText}));throw new Error(g.error||"Failed to generate PR description")}const c=await i.json().catch(()=>null),l=typeof c?.title=="string"?c.title:"",d=typeof c?.body=="string"?c.body:"";if(!l&&!d)throw new Error("Malformed PR description response");return{title:l,body:d}}async function As(t){const n=await fetch(J(`${q}/worktrees`,t));if(!n.ok){const e=await n.json().catch(()=>({error:n.statusText}));throw new Error(e.error||"Failed to list worktrees")}return n.json()}async function xs(t,n){const e=await fetch(J(`${q}/worktrees/validate`,t),{method:"POST",headers:{"Content-Type":"application/json"},body:JSON.stringify(n??{})});if(!e.ok){const s=await e.json().catch(()=>({error:e.statusText}));throw new Error(s.error||"Failed to validate worktree")}return e.json()}async function vs(t,n){const e=await fetch(J(`${q}/worktrees`,t),{method:"POST",headers:{"Content-Type":"application/json"},body:JSON.stringify(n??{})});if(!e.ok){const s=await e.json().catch(()=>({error:e.statusText}));throw new Error(s.error||"Failed to create worktree")}return e.json()}async function bs(t,n){const e=await fetch(J(`${q}/worktrees`,t),{method:"DELETE",headers:{"Content-Type":"application/json"},body:JSON.stringify(n??{})});if(!e.ok){const s=await e.json().catch(()=>({error:e.statusText}));throw new Error(s.error||"Failed to delete worktree")}return e.json()}async function Ds(t,n,e){const s=await fetch(J(`${q}/branches/rename`,t),{method:"PUT",headers:{"Content-Type":"application/json"},body:JSON.stringify({oldName:n,newName:e})});if(!s.ok){const r=await s.json().catch(()=>({error:s.statusText}));throw new Error(r.error||"Failed to rename branch")}return s.json()}async function Cs(){const t=await fetch(J(`${q}/identities`,void 0));if(!t.ok)throw new Error(`Failed to get git identities: ${t.statusText}`);return t.json()}async function ks(t){const n=await fetch(J(`${q}/identities`,void 0),{method:"POST",headers:{"Content-Type":"application/json"},body:JSON.stringify(t)});if(!n.ok){const e=await n.json().catch(()=>({error:n.statusText}));throw new Error(e.error||"Failed to create git identity")}return n.json()}async function Ps(t,n){const e=await fetch(J(`${q}/identities/${t}`,void 0),{method:"PUT",headers:{"Content-Type":"application/json"},body:JSON.stringify(n)});if(!e.ok){const s=await e.json().catch(()=>({error:e.statusText}));throw new Error(s.error||"Failed to update git identity")}return e.json()}async function Ts(t){const n=await fetch(J(`${q}/identities/${t}`,void 0),{method:"DELETE"});if(!n.ok){const e=await n.json().catch(()=>({error:n.statusText}));throw new Error(e.error||"Failed to delete git identity")}}async function Es(){const t=await fetch(J(`${q}/global-identity`,void 0));if(!t.ok)throw new Error(`Failed to get global git identity: ${t.statusText}`);const n=await t.json();return!n||!n.userName&&!n.userEmail?null:{userName:n.userName??null,userEmail:n.userEmail??null,sshCommand:n.sshCommand??null}}async function _s(){const t=await fetch(J(`${q}/discover-credentials`,void 0));if(!t.ok)throw new Error(`Failed to discover git credentials: ${t.statusText}`);return t.json()}async function Is(t){const n=await fetch(J(`${q}/remotes`,t));if(!n.ok)throw new Error(`Failed to get remotes: ${n.statusText}`);return n.json()}async function Fs(t){const n=await fetch(J(`${q}/conflict-details`,t));if(!n.ok)throw new Error(`Failed to get conflict details: ${n.statusText}`);return n.json()}const K=()=>typeof window<"u"&&window.__OPENCHAMBER_RUNTIME_APIS__?.git?window.__OPENCHAMBER_RUNTIME_APIS__.git:null;async function Us(t){const n=K();return n?n.checkIsGitRepository(t):ps(t)}async function Nt(t){const n=K();return n?n.getGitStatus(t):Ss(t)}async function qn(t){const n=K();return n?n.getGitBranches(t):ys(t)}async function Jn(t,n){const e=K();return e?e.deleteGitBranch(t,n):hs(t,n)}async function Rs(t,n){const e=K();return e?e.deleteRemoteBranch(t,n):Ms(t,n)}async function Kn(t,n){const e=K();return e?.generatePullRequestDescription?e.generatePullRequestDescription(t,n):ws(t,n)}async function js(t){const n=K();return n?.worktree?.list?n.worktree.list(t):n?n.listGitWorktrees(t):As(t)}async function Os(t,n){const e=K();return e?.worktree?.validate?e.worktree.validate(t,n):e?.validateGitWorktree?e.validateGitWorktree(t,n):xs(t,n)}async function Ls(t,n){const e=K();return e?.worktree?.create?e.worktree.create(t,n):e?.createGitWorktree?e.createGitWorktree(t,n):vs(t,n)}async function Bs(t,n){const e=K();return e?.worktree?.remove?e.worktree.remove(t,n):e?.deleteGitWorktree?e.deleteGitWorktree(t,n):bs(t,n)}const Je={worktree:{list:js,validate:Os,create:Ls,remove:Bs}};async function Qn(t,n,e){const s=K();return s?s.renameBranch(t,n,e):Ds(t,n,e)}async function Zn(){const t=K();return t?t.getGitIdentities():Cs()}async function Xn(t){const n=K();return n?n.createGitIdentity(t):ks(t)}async function Yn(t,n){const e=K();return e?e.updateGitIdentity(t,n):Ps(t,n)}async function er(t){const n=K();return n?n.deleteGitIdentity(t):Ts(t)}async function tr(){const t=K();return t?.discoverGitCredentials?t.discoverGitCredentials():_s()}async function sr(){const t=K();return t?.getGlobalGitIdentity?t.getGlobalGitIdentity():Es()}async function nr(t){const n=K();return n?n.getRemotes(t):Is(t)}async function rr(t){const n=K();return n?.getConflictDetails?n.getConflictDetails(t):Fs(t)}const Ze="/api",Ws=()=>(Ze.startsWith("/"),Ze);function Ns(){if(typeof window>"u")return null;const t=window.__OPENCHAMBER_RUNTIME_APIS__;return t?.files?t.files:null}async function $s(t,n){const e=Ns();if(e?.execCommands)return e.execCommands(t,n);const s=await fetch(`${Ws()}/fs/exec`,{method:"POST",headers:{"Content-Type":"application/json"},body:JSON.stringify({commands:t,cwd:n,background:!1})});if(!s.ok){const o=await s.json().catch(()=>({error:s.statusText}));throw new Error(o.error||"Command exec failed")}const r=await s.json().catch(()=>null);return{success:!!r?.success,results:Array.isArray(r?.results)?r.results:[]}}async function wt(t,n){const e=await $s([t],n),s=e.results[0];return s||{command:t,success:e.success}}const le=t=>{if(!t)return"";const n=t.replace(/\\/g,"/");return n==="/"?"/":n.replace(/\/+$/,"")},zs=(t,n)=>{const e=le(t),s=le(n);if(!s)return e;if(s.startsWith("/"))return s;const r=e.split("/").filter(Boolean),o=s.split("/").filter(Boolean);for(const a of o)if(a!=="."){if(a===".."){r.pop();continue}r.push(a)}return`/${r.join("/")}`},At=t=>{const n=le(t);if(!n)return null;if(n.endsWith("/.git"))return n.slice(0,-5)||null;const s=n.indexOf("/.git/worktrees/");return s>0&&n.slice(0,s)||null};async function Gs(t){const n=le(t),e=await Nt(n);return{isDirty:!e.isClean,ahead:e.ahead,behind:e.behind,upstream:e.tracking}}async function or(t){const n=le(t);if(!n)return"HEAD";const e=async s=>{const r=await wt("git rev-parse --absolute-git-dir",s),o=le((r.stdout||"").trim());if(r.success&&o){const d=At(o);if(d)return d}const a=await wt("git rev-parse --git-common-dir",s),i=le((a.stdout||"").trim());if(!a.success||!i)return s;const c=zs(s,i),l=At(c);return l||s};try{const s=await e(n).catch(()=>n),r=await Nt(s);return(typeof r.current=="string"?r.current.trim():"")||"HEAD"}catch{return"HEAD"}}const Hs="openchamber.json",Vs=".openchamber",qs=[".config","openchamber"],Js=[".config","openchamber","projects"],Ks="settings.json",Xe=new Map,xt=t=>/^[A-Za-z0-9._-]+$/.test(t),Qs=t=>{let n="";for(const e of t)n+=e.toString(16).padStart(2,"0");return n},Zs=async t=>{try{if(typeof crypto>"u"||!crypto.subtle)return null;const e=new TextEncoder().encode(t),s=await crypto.subtle.digest("SHA-1",e);return Qs(new Uint8Array(s))}catch{return null}};function Ke(){if(typeof window>"u")return null;const t=window.__OPENCHAMBER_RUNTIME_APIS__;return t?.files?t.files:null}const Xs=1e3,Ys=120,Ie=t=>{if(!t)return"";const n=t.replace(/\\/g,"/");return n==="/"?"/":n.replace(/\/+$/,"")},Me=(t,n)=>{const e=Ie(t),s=n.replace(/\\/g,"/").replace(/^\/+/,"").replace(/\/+$/,"");return!e||e==="/"?`/${s}`:`${e}/${s}`},$t=t=>Me(Me(t,Vs),Hs),Ue=()=>{const t="/api";return t.startsWith("/"),t},dt=async(t,n)=>{try{const e=await fetch(t,{method:"POST",headers:{"Content-Type":"application/json"},body:JSON.stringify(n)});return e.ok?{ok:!0,data:await e.json().catch(()=>null)}:{ok:!1,data:null}}catch{return{ok:!1,data:null}}},en=async t=>{const n=Ke();if(n?.createDirectory)try{if((await n.createDirectory(t))?.success)return!0}catch{}return!!(await dt(`${Ue()}/fs/mkdir`,{path:t})).ok},zt=async t=>{const n=Ke();if(n?.readFile)try{const e=await n.readFile(t);return typeof e?.content=="string"?e.content:""}catch{return null}try{const e=await fetch(`${Ue()}/fs/read?path=${encodeURIComponent(t)}`);return e.ok?await e.text():null}catch{return null}},tn=async(t,n)=>{const e=Ke();if(e?.writeFile)try{if((await e.writeFile(t,n))?.success)return!0}catch{}return!!(await dt(`${Ue()}/fs/write`,{path:t,content:n})).ok},Gt=async()=>{if(!ls()){const t=await ds().catch(()=>null);if(t&&t.trim().length>0)return Ie(t)}try{const t=await fetch(`${Ue()}/fs/home`);if(!t.ok)return null;const n=await t.json().catch(()=>null),e=typeof n?.home=="string"?n.home.trim():"";return e?Ie(e):null}catch{return null}},sn=async()=>{const t=await Gt();return t?qs.reduce((n,e)=>Me(n,e),t):null},Ht=async()=>{const t=await Gt();return t?Js.reduce((n,e)=>Me(n,e),t):null},nn=async()=>{const t=await sn();return t?Me(t,Ks):null},rn=async t=>{const n=typeof t?.path=="string"?t.path.trim():"",e=n?Ie(n):"",s=typeof t?.id=="string"?t.id.trim():"";if(s&&xt(s))return s;if(e){const o=Xe.get(e);if(o)return o}const r=await nn();if(r&&e){const o=await zt(r);if(o)try{const a=JSON.parse(o),i=Array.isArray(a?.projects)?a.projects:[];for(const c of i){if(!c||typeof c!="object")continue;const l=c,d=typeof l.id=="string"?l.id.trim():"",g=typeof l.path=="string"?Ie(l.path.trim()):"";if(d&&xt(d)&&g&&g===e)return Xe.set(e,d),d}}catch{}}if(e){const o=await Zs(e),a=o?`path_${o}`:`path_${e.replace(/[^A-Za-z0-9._-]+/g,"_")}`;return Xe.set(e,a),a}return null},Vt=async t=>{const n=await Ht();if(!n)return null;const e=await rn(t);return e?Me(n,`${e}.json`):null},qt=(t,n)=>t.length<=n?t:t.slice(0,n),on=t=>typeof t!="string"?"":qt(t,Xs),an=t=>{if(!Array.isArray(t))return[];const n=[];for(const e of t){if(!e||typeof e!="object")continue;const s=e,r=typeof s.id=="string"?s.id.trim():"",o=typeof s.text=="string"?s.text:"",a=qt(o.trim(),Ys);if(!r||!a)continue;const i=!!s.completed,c=typeof s.createdAt=="number"&&Number.isFinite(s.createdAt)&&s.createdAt>=0?s.createdAt:Date.now();n.push({id:r,text:a,completed:i,createdAt:c})}return n},Jt=t=>({notes:on(t?.notes),todos:an(t?.todos)});async function ut(t){const n=typeof t?.path=="string"?t.path.trim():"";if(!n)return null;const e=await Vt(t),s=async i=>{const c=await zt(i);return c===null?null:c},r=i=>{if(typeof i!="string")return null;const c=i.trim();if(!c)return null;try{const l=JSON.parse(c);return!l||typeof l!="object"?null:l}catch{return null}};if(e){const i=r(await s(e));if(i)return i}const o=$t(n),a=r(await s(o));if(!a)return null;try{await Kt(t,a)&&await ln(n)}catch{}return a}async function Kt(t,n){if(!(typeof t?.path=="string"?t.path.trim():""))return!1;const s=await Ht(),r=await Vt(t);if(!s||!r)return!1;try{if(!await en(s))return!1;const a=JSON.stringify(n,null,2);return await tn(r,a)}catch(o){return console.error("Failed to write openchamber config:",o),!1}}async function Qt(t,n){const s={...await ut(t)||{},...n};return Kt(t,s)}async function ir(t){return(await ut(t))?.["setup-worktree"]??[]}async function ar(t,n){const e=n.filter(s=>s.trim().length>0);return Qt(t,{"setup-worktree":e})}async function cr(t){const n=await ut(t);return Jt({notes:n?.projectNotes,todos:n?.projectTodos})}async function lr(t,n){const e=Jt({notes:n.notes,todos:n.todos});return Qt(t,{projectNotes:e.notes,projectTodos:e.todos})}function cn(t,n){return t.replace(/\$ROOT_PROJECT_PATH/g,n.rootWorktreePath).replace(/\$\{ROOT_PROJECT_PATH\}/g,n.rootWorktreePath).replace(/\$ROOT_WORKTREE_PATH/g,n.rootWorktreePath).replace(/\$\{ROOT_WORKTREE_PATH\}/g,n.rootWorktreePath)}async function ln(t){const n=$t(t),e=Ke();if(e?.delete)try{await e.delete(n);return}catch{}try{await dt(`${Ue()}/fs/delete`,{path:n})}catch{}}const Ee=t=>{const n=t.replace(/\\/g,"/");return n==="/"?"/":n.length>1?n.replace(/\/+$/,""):n},dn=t=>t.trim().replace(/^refs\/heads\//,"").replace(/^heads\//,"").replace(/\s+/g,"-").replace(/^\/+|\/+$/g,"").split("/").join("-").replace(/[^A-Za-z0-9._-]+/g,"-").replace(/-+/g,"-").replace(/^-+|-+$/g,"").slice(0,80),vt=t=>t.trim().replace(/^refs\/heads\//,"").replace(/^heads\//,"").replace(/\s+/g,"-").replace(/^\/+|\/+$/g,""),bt=t=>{const n=Ee(t),e=n.split("/").filter(Boolean);return e[e.length-1]??n},un=t=>{const n=[];for(const s of t.setupCommands){const r=s.trim();r&&n.push(cn(r,{rootWorktreePath:t.projectDirectory}))}const e=n.filter(Boolean).join(" && ");return e.trim().length>0?e:void 0},Zt=(t,n)=>{const e=t.mode==="existing"?"existing":"new",s=t.worktreeName??t.preferredName??"",r=dn(s),o=t.branchName??(e==="new"?t.preferredName:void 0)??"",a=vt(o),i=vt(t.existingBranch??t.branchName??""),c=(t.startRef||"").trim(),l=Array.isArray(t.setupCommands)?t.setupCommands:[],d=un({projectDirectory:n,setupCommands:l});return{mode:e,...r?{worktreeName:r}:{},...a?{branchName:a}:{},...i?{existingBranch:i}:{},...c?{startRef:c}:{},...d?{startCommand:d}:{},...t.setUpstream?{setUpstream:!0}:{},...t.upstreamRemote?{upstreamRemote:t.upstreamRemote}:{},...t.upstreamBranch?{upstreamBranch:t.upstreamBranch}:{},...t.ensureRemoteName?{ensureRemoteName:t.ensureRemoteName}:{},...t.ensureRemoteUrl?{ensureRemoteUrl:t.ensureRemoteUrl}:{}}};async function Xt(t){const n=t.path,e=Ee(n);return(await Je.worktree.list(n).catch(()=>[])).filter(o=>typeof o.path=="string"&&o.path.trim().length>0).map(o=>{const a=Ee(o.path),i=(o.branch||"").replace(/^refs\/heads\//,"").trim(),c=(o.name||"").trim();return{source:"sdk",name:c||bt(a),path:a,projectDirectory:n,branch:i,label:i||c||bt(a)}}).filter(o=>Ee(o.path)!==e).sort((o,a)=>{const i=(o.label||o.branch||o.path).toLowerCase(),c=(a.label||a.branch||a.path).toLowerCase();return i.localeCompare(c)})}async function dr(t,n){const e=t.path,s=Zt(n,e),r=await Je.worktree.create(e,s),o=typeof r?.name=="string"?r.name:"",a=typeof r?.branch=="string"?r.branch:"",i=typeof r?.path=="string"?r.path:"";if(!o||!i)throw new Error("Worktree create missing name/path");return{source:"sdk",name:o,path:Ee(i),projectDirectory:e,branch:a,label:a||o}}async function ur(t,n){const e=t.path,s=Zt(n,e);return Je.worktree.validate(e,s)}async function gn(t,n,e){const s=t.path,r=!!e?.deleteRemoteBranch,o=e?.deleteLocalBranch===!0,a=e?.remoteName;if(!(await Je.worktree.remove(s,{directory:n.path,deleteLocalBranch:o}))?.success)throw new Error("Worktree removal failed");const c=(n.branch||"").replace(/^refs\/heads\//,"").trim();r&&c&&await Rs(s,{branch:c,remote:a}).catch(()=>{})}const mn=150,fn=1100;let ze=null;const pn=()=>{ze&&ze()};function gr(){const t=ee.useRef(!1),n=ee.useRef(!1),e=ee.useRef(0),s=ee.useRef(null),r=ee.useRef(null),o=ee.useCallback(async(i=!1)=>{const c=Date.now();if(!(!i&&c-e.current<1e3)){if(t.current){i&&(n.current=!0);return}t.current=!0,e.current=c;try{const l=await fetch("/api/sessions/snapshot",{method:"GET",cache:"no-store",headers:{Accept:"application/json"}});if(!l.ok){console.warn("[useServerSessionStatus] Failed to fetch session snapshot:",l.status);return}const d=await l.json(),g=d.statusSessions??{},y=d.attentionSessions??{},m=Q.getState().sessionStatus||new Map;let S=null;const p=()=>(S||(S=new Map(m)),S);for(const[M,A]of Object.entries(g)){const C=m.get(M);(!C||C.type!==A.status||C.attempt!==A.metadata?.attempt||C.message!==A.metadata?.message||C.next!==A.metadata?.next||C.confirmedAt!==A.lastUpdateAt)&&p().set(M,{type:A.status,confirmedAt:A.lastUpdateAt,attempt:A.metadata?.attempt,message:A.metadata?.message,next:A.metadata?.next})}for(const[M,A]of S??m)(A.type==="busy"||A.type==="retry")&&!g[M]&&p().set(M,{type:"idle",confirmedAt:Date.now()});const h=Q.getState().sessionAttentionStates||new Map;let u=null;const f=()=>(u||(u=new Map(h)),u);let w=!1;for(const[M,A]of Object.entries(y)){const C=h.get(M),D=A;(!C||C.needsAttention!==D.needsAttention||C.lastUserMessageAt!==D.lastUserMessageAt||C.lastStatusChangeAt!==D.lastStatusChangeAt||C.status!==D.status||C.isViewed!==D.isViewed)&&(f().set(M,D),w=!0)}for(const M of(u??h).keys()){const A=!!g[M],C=!!y[M];!A&&!C&&(f().delete(M),w=!0)}const v=S!==null;(v||w)&&Q.setState({...v&&S?{sessionStatus:S}:{},...w&&u?{sessionAttentionStates:u}:{}})}catch(l){console.warn("[useServerSessionStatus] Error fetching session status:",l)}finally{t.current=!1,n.current&&(n.current=!1,setTimeout(()=>{o(!0)},120))}}},[]),a=ee.useCallback(()=>{s.current&&clearTimeout(s.current),r.current&&clearTimeout(r.current),s.current=setTimeout(()=>{o(!0)},mn),r.current=setTimeout(()=>{o(!0)},fn)},[o]);return ee.useEffect(()=>(o(!0),()=>{s.current&&clearTimeout(s.current),r.current&&clearTimeout(r.current)}),[o]),ee.useEffect(()=>{const i=()=>{document.visibilityState==="visible"&&a()};return document.addEventListener("visibilitychange",i),()=>{document.removeEventListener("visibilitychange",i)}},[a]),ee.useEffect(()=>(ze=a,()=>{ze=null}),[a]),{fetchSessionStatus:o,triggerImmediatePoll:a}}const Yt=de(),es="oc.sessionSelectionByDirectory",Sn=()=>{try{const t=Yt.getItem(es);if(!t)return{};const n=JSON.parse(t);return!n||typeof n!="object"?{}:Object.entries(n).reduce((e,[s,r])=>(typeof s=="string"&&typeof r=="string"&&s.length>0&&r.length>0&&(e[s]=r),e),{})}catch{return{}}};let Ne=null;const gt=()=>(Ne||(Ne=Sn()),Ne),ts=t=>{Ne=t;try{Yt.setItem(es,JSON.stringify(t))}catch{}},ss=t=>{if(!t)return null;const e=gt()[t];return typeof e=="string"?e:null},se=(t,n)=>{if(!t)return;const e={...gt()};n?e[t]=n:delete e[t],ts(e)},yn=(t,n)=>{if(!t)return;const e=ss(t);if(!e)return;if(!new Set(n).has(e)){const r={...gt()};delete r[t],ts(r)}},Dt=async(t,n)=>{const e=t.status??await Gs(t.path).catch(()=>{}),s=at.getState().projects,r=E(t.projectDirectory)??t.projectDirectory,a={id:s.find(i=>E(i.path)===r)?.id??`path:${r}`,path:r};await gn(a,e?{...t}:t,{deleteRemoteBranch:n?.deleteRemoteBranch,deleteLocalBranch:n?.deleteLocalBranch,remoteName:n?.remoteName})},Ct=async(t,n)=>{const e=F.getApiClient(),s=E(n??null);return!!(await e.session.delete({sessionID:t,...s?{directory:s}:{}})).data},E=t=>{if(typeof t!="string")return null;const n=t.trim();if(!n)return null;const e=n.replace(/\\/g,"/");return e==="/"?"/":e.length>1?e.replace(/\/+$/,""):e},kt=()=>{if(typeof window>"u")return null;const t=window.__VSCODE_CONFIG__,n=typeof t?.workspaceFolder=="string"?t.workspaceFolder:null;return E(n)},hn=()=>typeof window>"u"?!1:!!window.__OPENCHAMBER_RUNTIME_APIS__?.runtime?.isVSCode,je=(...t)=>{us()&&hn()&&console.log("[OpenChamber][VSCode][sessions]",...t)},ne=t=>{const n=new Map;return t.forEach(e=>{if(!e||typeof e.id!="string"||e.id.length===0)return;const s=n.get(e.id);if(!s){n.set(e.id,e);return}const r=s.time?.updated??0;(e.time?.updated??0)>r&&n.set(e.id,e)}),Array.from(n.values())},Y=t=>{const n=new Map;t.forEach(e=>{const s=E(e.directory??null);if(!s)return;const r=n.get(s);r?r.push(e):n.set(s,[e])});for(const[e,s]of n.entries())n.set(e,ne(s));return n},me=(t,n)=>{const e=t.find(s=>s.id===n);return e?E(e.directory??null):null},Mn=async(t,n,e)=>{const s=E(n);if(!s||t.length===0)return null;const r=t.map(d=>({id:d.id,directory:E(d.directory)})).filter(d=>!!d.directory);if(r.length===0)return null;let o;try{o=await Xt({id:`path:${s}`,path:s})}catch(d){return console.debug("Failed to hydrate worktree metadata from worktree list:",d),null}if(!Array.isArray(o)||o.length===0){let d=!1;const g=new Map(e);return r.forEach(({id:y})=>{g.delete(y)&&(d=!0)}),d?g:null}const a=new Map;o.forEach(d=>{const g=E(d.path)??d.path;g!==s&&a.set(g,d)});let i=!1;const c=new Map(e),l=(d,g)=>g?{...g,...d,branch:d.branch||g.branch,label:d.label||g.label,name:d.name||g.name,projectDirectory:d.projectDirectory||g.projectDirectory,createdFromBranch:d.createdFromBranch||g.createdFromBranch,kind:d.kind||g.kind,status:d.status||g.status}:d;return r.forEach(({id:d,directory:g})=>{const y=a.get(g);if(!y){c.delete(d)&&(i=!0);return}const m=c.get(d),S=l(y,m);(!m||m.path!==S.path||m.branch!==S.branch||m.label!==S.label||m.name!==S.name||m.projectDirectory!==S.projectDirectory||m.createdFromBranch!==S.createdFromBranch||m.kind!==S.kind||m.source!==S.source)&&(c.set(d,S),i=!0)}),i?c:null},I=ue()(ge(we((t,n)=>({sessions:[],sessionsByDirectory:new Map,currentSessionId:null,lastLoadedDirectory:null,isLoading:!1,error:null,webUICreatedSessions:new Set,worktreeMetadata:new Map,availableWorktrees:[],availableWorktreesByProject:new Map,loadSessions:async()=>{t({isLoading:!0,error:null});try{const e=Pe.getState(),s=at.getState(),r=F.getApiClient(),o=kt(),a=!!o;je("loadSessions:start",{workspace:o,currentDirectory:e.currentDirectory,clientDirectory:F.getDirectory(),projectsCount:s.projects.length,activeProjectId:s.activeProjectId});const i=new Map,c=async x=>{const P=E(x)??x,R=P,O=i.get(R);if(O)return O;try{const U=await r.path.get({directory:x}),V=E(U.data?.directory??null)??P;return i.set(R,V),V}catch{return i.set(R,P),P}},l=(x,P,R)=>{const O=E(P);if(!O)return x;const z=R?.includeDescendants===!0?`${O}/`:null,V=R?.includeMissingDirectory===!0;return x.filter(G=>{const j=E(G.directory??null);return j?!!(j===O||z&&j.startsWith(z)):V})},d=(x,P,R)=>{const O=E(P);if(!O)return x;const U=E(R??null);if(!U||U===O)return x.map(G=>E(G.directory??null)?G:{...G,directory:O});const z=U==="/"?"/":`${U}/`,V=O==="/"?"/":`${O}/`;return x.map(G=>{const j=E(G.directory??null);if(!j)return{...G,directory:O};if(j===U)return{...G,directory:O};if(z!=="/"&&j.startsWith(z)){const X=j.slice(z.length);return{...G,directory:`${V}${X}`}}return G})},g=async x=>{const P=E(x);if(!P)try{const j=await r.session.list(void 0);return Array.isArray(j.data)?j.data:[]}catch(j){throw console.debug("Failed to list sessions (global):",j),j}const R=await c(P),O=async()=>{const j=await r.session.list({directory:P});return Array.isArray(j.data)?j.data:[]};let U=[],z=null,V=!1;try{U=await O()}catch(j){console.debug("Failed to list sessions for directory:",P,j),z=j,U=[]}if(U.length===0){V=!0;try{const j=await r.session.list(void 0),X=Array.isArray(j.data)?j.data:[];U=l(X,R,{includeDescendants:a,includeMissingDirectory:!1})}catch(j){throw console.debug("Failed to list sessions (global fallback):",j),z||j}}const G=l(U,R,{includeDescendants:a,includeMissingDirectory:!V});return je("fetchSessionsForDirectory",{requestedDirectory:P,canonicalDirectory:R,fetched:U.length,filtered:G.length}),d(G,P,R)},y=E(e.currentDirectory??F.getDirectory()??null),m=s.projects.find(x=>x.id===s.activeProjectId)??null,S=E(m?.path??null),p=S??y??null,h=s.projects.length>0?s.projects:p?[{id:"legacy",path:p}]:[];if(h.length===0){t({sessions:[],sessionsByDirectory:new Map,currentSessionId:null,lastLoadedDirectory:null,isLoading:!1,worktreeMetadata:new Map,availableWorktrees:[],availableWorktreesByProject:new Map});return}const u=await Promise.all(h.map(async x=>{const P=E(x.path);if(!P)return{projectId:x.id,projectPath:null,sessions:[],discoveredWorktrees:[],validPaths:new Set};const R=await Us(P).catch(()=>!1),O=await g(P||null);je("projectSessions",{projectId:x.id,projectPath:P,isGitRepo:R,parentSessions:O.length});const U=[];let z=[];const V=new Set;if(V.add(P),R)try{const j=new Set,X=await Xt({id:x.id,path:P}).catch(()=>[]);z=X,X.forEach(H=>{H?.path&&j.add(E(H.path)??H.path)}),j.forEach(H=>{const Z=E(H)??H;V.add(Z)}),j.size>0&&(await Promise.allSettled(Array.from(j).map(Z=>g(Z)))).forEach(Z=>{Z.status==="fulfilled"&&Array.isArray(Z.value)&&U.push(...Z.value)})}catch{z=[]}const G=ne([...O,...U]);return{projectId:x.id,projectPath:P,sessions:G,discoveredWorktrees:z,validPaths:V}})),f=new Map;u.forEach(x=>{x.projectPath&&x.validPaths.forEach(P=>{const R=E(P)??P,O=x.sessions.filter(U=>(E(U.directory??null)??R)===R);f.set(R,ne(O))})});const w=ne(Array.from(f.values()).flat()),v=n();let M=v.worktreeMetadata;for(const x of u)if(x.projectPath)try{const P=await Mn(x.sessions,x.projectPath,M);P&&(M=P)}catch(P){console.debug("Failed to refresh worktree metadata during session load:",P)}const A=new Map;u.forEach(x=>{x.projectPath&&A.set(x.projectPath,x.discoveredWorktrees)});const C=new Set;u.forEach(x=>{x.validPaths.forEach(P=>{const R=E(P)??P;R&&C.add(R)})});const D=y??S??null,b=D&&C.has(D)?D:S??D,k=b?f.get(b)??[]:w,T=new Set(w.map(x=>x.id));for(const[x,P]of f.entries())yn(x,P.map(R=>R.id));const _=(b??null)!==(v.lastLoadedDirectory??null);let W=v.currentSessionId;if((!W||!T.has(W)||_)&&(W=k[0]?.id??w[0]?.id??null),b){const x=ss(b);x&&T.has(x)&&(W=x)}const N=(()=>{if(!W)return b??null;const x=M.get(W)?.path;if(x)return E(x)??x;const P=me(w,W);return P||(b??null)})();try{F.setDirectory(N??void 0)}catch(x){console.warn("Failed to sync OpenCode directory after session load:",x)}const $=S?u.find(x=>x.projectPath===S)?.discoveredWorktrees??[]:[];t({sessions:w,sessionsByDirectory:f,currentSessionId:W,lastLoadedDirectory:b??null,isLoading:!1,worktreeMetadata:M,availableWorktrees:$,availableWorktreesByProject:A}),b&&se(b,W),N&&N!==b&&se(N,W)}catch(e){t({error:e instanceof Error?e.message:"Failed to load sessions",isLoading:!1})}},createSession:async(e,s,r)=>{t({error:null});const o=Pe.getState(),a=E(o.currentDirectory),i=kt(),c=i??E(s??F.getDirectory()??a);je("createSession:start",{title:e,parentID:r,targetDirectory:c,vscodeWorkspaceDirectory:i});const l=`temp_${Date.now()}_${Math.random().toString(36).slice(2,7)}`,d=n(),g=new Set(d.sessions.map(p=>p.id)),y={id:l,title:e||"New session",parentID:r??void 0,directory:c??null,projectID:d.sessions[0]?.projectID??"",version:"0.0.0",time:{created:Date.now(),updated:Date.now()},summary:void 0,share:void 0};if(t(p=>{const h=[y,...p.sessions],u=new Map(p.sessionsByDirectory);if(c){const f=u.get(c)??[];u.set(c,ne([y,...f]))}return{sessions:h,sessionsByDirectory:u,currentSessionId:l,webUICreatedSessions:new Set([...p.webUICreatedSessions,l]),isLoading:!1}}),c)try{F.setDirectory(c)}catch(p){console.warn("Failed to sync OpenCode directory after session creation:",p)}const m=p=>{const h=c??null,u=h?{...p,directory:h}:p;t(f=>{const w=f.sessions.map(M=>M.id===l?u:M),v=new Map(f.sessionsByDirectory);if(c){const A=(v.get(c)??[]).map(C=>C.id===l?u:C);v.set(c,ne(A))}return{sessions:w,sessionsByDirectory:Y(w),currentSessionId:u.id,webUICreatedSessions:new Set([...Array.from(f.webUICreatedSessions).filter(M=>M!==l),u.id])}}),se(c??null,u.id)},S=async()=>{const p=F.getApiClient(),h=20;for(let u=0;u<h;u+=1){try{const f=await p.session.list(c?{directory:c}:void 0),v=(Array.isArray(f.data)?f.data:[]).find(M=>!(g.has(M.id)||e&&M.title&&M.title!==e));if(v)return v}catch(f){console.debug("Session poll attempt failed:",f)}await new Promise(f=>setTimeout(f,2e3))}return null};try{const p=()=>F.createSession({title:e,parentID:r??void 0});let h=null;try{h=c?await F.withDirectory(c,p):await p()}catch(u){console.warn("Direct session create failed or timed out, falling back to polling:",u)}return h||(h=await S()),h?(m(h),h):(t(u=>({sessions:u.sessions.filter(f=>f.id!==l),currentSessionId:d.currentSessionId,webUICreatedSessions:new Set(Array.from(u.webUICreatedSessions).filter(f=>f!==l)),isLoading:!1,error:"Failed to create session"})),null)}catch(p){return t(h=>({sessions:h.sessions.filter(u=>u.id!==l),currentSessionId:d.currentSessionId,webUICreatedSessions:new Set(Array.from(h.webUICreatedSessions).filter(u=>u!==l)),isLoading:!1,error:p instanceof Error?p.message:"Failed to create session"})),null}},deleteSession:async(e,s)=>{t({isLoading:!0,error:null});const r=n().worktreeMetadata.get(e),o=typeof r?.path=="string"?r.path:null,a=typeof r?.projectDirectory=="string"?r.projectDirectory:null,i=me(n().sessions,e),c=E(a)??E(i)??E(F.getDirectory()??null)??null;let l=!1;try{if(!await Ct(e,c))return t({isLoading:!1,error:"Failed to delete session"}),!1;if(r&&s?.archiveWorktree)try{await Dt(r,{deleteRemoteBranch:s?.deleteRemoteBranch,deleteLocalBranch:s?.deleteLocalBranch,remoteName:s?.remoteName}),l=!0}catch(m){const S=m instanceof Error?m.message:"Failed to delete worktree";t({error:S})}let g=null;t(m=>{const S=m.sessions.filter(w=>w.id!==e);g=m.currentSessionId===e?null:m.currentSessionId;const p=new Map(m.worktreeMetadata);p.delete(e);const h=!!(o&&s?.archiveWorktree&&l),u=h?m.availableWorktrees.filter(w=>E(w.path)!==E(o)):m.availableWorktrees,f=new Map(m.availableWorktreesByProject);if(h&&a){const w=E(a)??a,v=f.get(w)??[];f.set(w,v.filter(M=>E(M.path)!==E(o)))}return{sessions:S,sessionsByDirectory:Y(S),currentSessionId:g,isLoading:!1,worktreeMetadata:p,availableWorktrees:u,availableWorktreesByProject:f}});const y=E(i)??E(F.getDirectory()??null)??null;return se(y,g),!0}catch(d){const g=d instanceof Error?d.message:"Failed to delete session";return t({error:g,isLoading:!1}),!1}},deleteSessions:async(e,s)=>{const r=Array.from(new Set(e.filter(u=>typeof u=="string"&&u.length>0)));if(r.length===0)return{deletedIds:[],failedIds:[]};const o=s?.silent===!0;o||t({isLoading:!0,error:null});const a=[],i=[],c=new Map,l=new Set;for(const u of r)try{const f=n().worktreeMetadata.get(u),w=me(n().sessions,u),v=E(f?.projectDirectory??null)??E(w)??E(F.getDirectory()??null)??null;if(f&&s?.archiveWorktree){const A=E(f.path)??f.path;l.has(A)||(l.add(A),c.set(A,f))}await Ct(u,v)?a.push(u):i.push(u)}catch{i.push(u)}const d=[],g=[];if(s?.archiveWorktree&&c.size>0)for(const u of c.values())try{await Dt(u,{deleteRemoteBranch:s?.deleteRemoteBranch,deleteLocalBranch:s?.deleteLocalBranch,remoteName:s?.remoteName}),d.push({path:u.path,projectDirectory:u.projectDirectory})}catch(f){const w=f instanceof Error?f.message:"Failed to delete worktree";g.push(w)}g.length>0&&t({error:g[0]});const y=Pe.getState();d.forEach(({path:u,projectDirectory:f})=>{y.currentDirectory===u&&y.setDirectory(f,{showOverlay:!1})});const m=new Set(a),S=i.length>0?i.length===r.length?"Failed to delete sessions":"Failed to delete some sessions":null;let p=null;t(u=>{const f=u.sessions.filter(C=>!m.has(C.id));u.currentSessionId&&m.has(u.currentSessionId)?p=null:p=u.currentSessionId;const w=new Map(u.worktreeMetadata);for(const C of m)w.delete(C);const v=new Set(d.map(C=>E(C.path)).filter(C=>!!C)),M=v.size>0?u.availableWorktrees.filter(C=>!v.has(E(C.path)??C.path)):u.availableWorktrees,A=new Map(u.availableWorktreesByProject);return d.length>0&&d.reduce((D,b)=>{const k=E(b.projectDirectory)??b.projectDirectory,T=E(b.path)??b.path;return D.has(k)||D.set(k,new Set),D.get(k)?.add(T),D},new Map).forEach((D,b)=>{const T=(A.get(b)??[]).filter(_=>!D.has(E(_.path)??_.path));A.set(b,T)}),{sessions:f,sessionsByDirectory:Y(f),currentSessionId:p,...o?{}:{isLoading:!1,error:S},worktreeMetadata:w,availableWorktrees:M,availableWorktreesByProject:A}});const h=F.getDirectory()??null;return se(h,p),{deletedIds:a,failedIds:i}},updateSessionTitle:async(e,s)=>{try{const r=me(n().sessions,e),o=n().worktreeMetadata.get(e),a=()=>F.updateSession(e,s),i=o?.path??r,c=i?await F.withDirectory(i,a):await a();t(l=>{const d=l.sessions.map(g=>g.id===e?c:g);return{sessions:d,sessionsByDirectory:Y(d)}})}catch(r){t({error:r instanceof Error?r.message:"Failed to update session title"})}},shareSession:async e=>{try{const s=me(n().sessions,e),r=F.getApiClient(),a=n().worktreeMetadata.get(e)?.path??s,i=async()=>{const l=s??F.getDirectory();return r.session.share({sessionID:e,...l?{directory:l}:{}})},c=a?await F.withDirectory(a,i):await i();return c.data?(t(l=>{const d=l.sessions.map(g=>g.id===e?c.data:g);return{sessions:d,sessionsByDirectory:Y(d)}}),c.data):null}catch(s){return t({error:s instanceof Error?s.message:"Failed to share session"}),null}},unshareSession:async e=>{try{const s=me(n().sessions,e),r=F.getApiClient(),a=n().worktreeMetadata.get(e)?.path??s,i=async()=>{const l=s??F.getDirectory();return r.session.unshare({sessionID:e,...l?{directory:l}:{}})},c=a?await F.withDirectory(a,i):await i();return c.data?(t(l=>{const d=l.sessions.map(g=>g.id===e?c.data:g);return{sessions:d,sessionsByDirectory:Y(d)}}),c.data):null}catch(s){return t({error:s instanceof Error?s.message:"Failed to unshare session"}),null}},setCurrentSession:e=>{const s=n().currentSessionId;t({currentSessionId:e,error:null}),s&&s!==e&&fetch(`/api/sessions/${s}/unview`,{method:"POST"}).catch(()=>{}),e&&fetch(`/api/sessions/${e}/view`,{method:"POST"}).catch(()=>{}),pn();const r=F.getDirectory()??null;se(r,e)},clearError:()=>{t({error:null})},getSessionsByDirectory:e=>{const s=E(e)??e,{sessionsByDirectory:r,sessions:o}=n(),a=r.get(s);return a||o.filter(i=>(E(i.directory??null)??s)===s)},getDirectoryForSession:e=>{if(!e)return null;const s=n().worktreeMetadata.get(e);if(s?.path)return E(s.path)??s.path;const r=n().sessions.find(a=>a.id===e);return E(r?.directory??null)},applySessionMetadata:(e,s)=>{!e||!s||t(r=>{const o=r.sessions.findIndex(m=>m.id===e);if(o===-1)return r;const a=r.sessions[o],i=s.time?{...a.time,...s.time}:a.time,c=s.summary===void 0?a.summary:s.summary||void 0,l=s.share===void 0?a.share:s.share||void 0,d={...a,...s,time:i,summary:c,share:l},g=d.title!==a.title||d.parentID!==a.parentID||d.directory!==a.directory||d.version!==a.version||d.projectID!==a.projectID||JSON.stringify(d.time)!==JSON.stringify(a.time)||JSON.stringify(d.summary??null)!==JSON.stringify(a.summary??null)||JSON.stringify(d.share??null)!==JSON.stringify(a.share??null),y=[...r.sessions];return y[o]=g?d:a,{sessions:y,sessionsByDirectory:Y(y)}})},isOpenChamberCreatedSession:e=>{const{webUICreatedSessions:s}=n();return s.has(e)},markSessionAsOpenChamberCreated:e=>{t(s=>{const r=new Set(s.webUICreatedSessions);return r.add(e),{webUICreatedSessions:r}})},initializeNewOpenChamberSession:e=>{const{markSessionAsOpenChamberCreated:s}=n();s(e)},setWorktreeMetadata:(e,s)=>{e&&t(r=>{const o=new Map(r.worktreeMetadata);return s?o.set(e,s):o.delete(e),{worktreeMetadata:o}})},getWorktreeMetadata:e=>{if(e)return n().worktreeMetadata.get(e)},setSessionDirectory:(e,s)=>{if(!e)return;const r=n().sessions,o=r.findIndex(l=>l.id===e);if(o===-1)return;const i=r[o].directory??null,c=s??void 0;i!==(c??null)&&(t(l=>{const d=[...l.sessions],g={...d[o]};return c!==void 0?g.directory=c:delete g.directory,d[o]=g,{sessions:d,sessionsByDirectory:Y(d)}}),i&&se(i,null),s&&se(s,e))},updateSession:e=>{t(s=>{const o=s.sessions.findIndex(i=>i.id===e.id)===-1?[e,...s.sessions]:s.sessions.map(i=>i.id===e.id?e:i),a=ne(o);return{sessions:a,sessionsByDirectory:Y(a)}})},removeSessionFromStore:e=>{e&&t(s=>{const r=s.sessions.find(l=>l.id===e),o=E(r?.directory??null),a=s.sessions.filter(l=>l.id!==e);if(a.length===s.sessions.length)return s;const i=new Map(s.worktreeMetadata);i.delete(e);const c=s.currentSessionId===e?null:s.currentSessionId;return o&&se(o,null),{sessions:a,sessionsByDirectory:Y(a),currentSessionId:c,worktreeMetadata:i}})}}),{name:"session-store",storage:Ae(()=>de()),partialize:t=>({currentSessionId:t.currentSessionId,sessions:t.sessions,lastLoadedDirectory:t.lastLoadedDirectory,webUICreatedSessions:Array.from(t.webUICreatedSessions),worktreeMetadata:Array.from(t.worktreeMetadata.entries()),availableWorktrees:t.availableWorktrees,availableWorktreesByProject:Array.from(t.availableWorktreesByProject.entries())}),merge:(t,n)=>{if(!(m=>typeof m=="object"&&m!==null)(t))return n;const s=Array.isArray(t.sessions)?t.sessions:n.sessions,r=typeof t.currentSessionId=="string"||t.currentSessionId===null?t.currentSessionId:n.currentSessionId,o=Array.isArray(t.webUICreatedSessions)?t.webUICreatedSessions:[],a=Array.isArray(t.worktreeMetadata)?t.worktreeMetadata:[],i=Array.isArray(t.availableWorktrees)?t.availableWorktrees:n.availableWorktrees,c=Array.isArray(t.availableWorktreesByProject)?t.availableWorktreesByProject:[],l=new Map(c),d=typeof t.lastLoadedDirectory=="string"?t.lastLoadedDirectory:n.lastLoadedDirectory??null,g=ne(s);return{...n,...t,sessions:g,sessionsByDirectory:Y(g),currentSessionId:r,webUICreatedSessions:new Set(o),worktreeMetadata:new Map(a),availableWorktrees:i,availableWorktreesByProject:l.size>0?l:n.availableWorktreesByProject,lastLoadedDirectory:d}}}),{name:"session-store"})),ns="This message comes from an AI assistant in another session. The user wants you to respond according to its content: if it is an implementation plan, your task is to implement that plan; if it is a conclusion or summary, your task is to verify it, explain whether you agree or disagree, and correct it if needed. Always clearly state what you understand your task to be, and wait for the user's approval of your conclusions before taking any further actions.",mr="This message bellow comes from an AI agent in another session. I want you to act according to its content: if it is an implementation plan, your task is to implement that plan; if it is a conclusion or summary, your task is to verify it, explain whether you agree or disagree, and correct it if needed; if it is a bug description, find the root cause and fix it. Proceed with actions right away based on your understanding of the task. Here is the content of the message: ",Ye=t=>typeof t=="string"&&t.trim()===ns.trim(),et=(t,n)=>{const e=Date.now(),s=t.get(n),r=new Map(t);return r.set(n,{phase:"streaming",startedAt:s?.startedAt??e,lastUpdateAt:e}),r},be=(t,n)=>{const e=Array.from(n);if(!e.some(o=>t.has(o)))return t;const r=new Map(t);return e.forEach(o=>{r.delete(o)}),r},Pt=new Map,rs=t=>{const n=Pt.get(t);n&&(clearTimeout(n),Pt.delete(t))},ie=t=>{for(const n of t)rs(n)},Fe=t=>{if(!t)return"";if(typeof t=="string")return t;if(Array.isArray(t))return t.map(n=>Fe(n)).join("");if(typeof t=="object"){if(typeof t.text=="string")return t.text;if(Array.isArray(t.content))return t.content.map(n=>Fe(n)).join("")}return""},Se=t=>{if(!t)return"";const n=t;if(typeof n.text=="string")return n.text;if(Array.isArray(n.text))return n.text.map(s=>typeof s=="string"?s:Se(s)).join("");const e=Fe(n.delta);return e||(typeof n.content=="string"?n.content:Array.isArray(n.content)?n.content.map(s=>{if(typeof s=="string")return s;if(s&&typeof s=="object"){const r=s;return r.text||Fe(r.delta)||""}return""}).join(""):"")},De=(t,n)=>{const e={...t};if(e.type=e.type||"text",e.type==="text"){const s=n&&typeof n.text=="string"?n.text:"",r=typeof e.text=="string"?e.text:"",o=Fe(t.delta);r?e.text=r:o?e.text=s?`${s}${o}`:o:s?e.text=s:e.text="",delete e.delta}return e},wn=50*1024*1024,An=t=>{const n=(t||"").toLowerCase();switch(n.includes(".")&&n.split(".").pop()||""){case"png":return"image/png";case"jpg":case"jpeg":return"image/jpeg";case"gif":return"image/gif";case"webp":return"image/webp";case"svg":return"image/svg+xml";case"bmp":return"image/bmp";case"ico":return"image/x-icon";case"pdf":return"application/pdf";default:return"application/octet-stream"}},xn=t=>{if(t.type&&t.type.trim().length>0)return t.type;const n=(t.name||"").toLowerCase(),e=n.includes(".")&&n.split(".").pop()||"";if(new Set(["license","readme","changelog","notice","authors","copying"]).has(n))return"text/plain";switch(e){case"md":case"markdown":return"text/markdown";case"txt":return"text/plain";case"json":return"application/json";case"yaml":case"yml":return"application/x-yaml";case"ts":case"tsx":case"js":case"jsx":case"mjs":case"cjs":case"py":case"rb":case"sh":case"bash":case"zsh":return"text/plain";default:return"application/octet-stream"}},it=t=>t.replace(/\\/g,"/").trim(),vn=t=>{const n=it(t);if(n.startsWith("file://"))return n;const e=n.startsWith("/")?n:`/${n}`;return`file://${encodeURI(e)}`},bn=async t=>{const n=await fetch(`/api/fs/raw?path=${encodeURIComponent(t)}`);if(!n.ok)throw new Error(`Failed to read raw file: ${n.status}`);const e=await n.blob();return await new Promise((s,r)=>{const o=new FileReader;o.onload=()=>s(o.result),o.onerror=r,o.readAsDataURL(e)})},ce=ue()(ge(we((t,n)=>({attachedFiles:[],addAttachedFile:async e=>{const{attachedFiles:s}=n();if(s.some(S=>S.filename===e.name&&S.size===e.size)){console.log(`File "${e.name}" is already attached`);return}const o=wn;if(e.size>o)throw new Error(`File "${e.name}" is too large. Maximum size is 50MB.`);const a=["text/","application/json","application/xml","application/pdf","image/","video/","audio/","application/javascript","application/typescript","application/x-python","application/x-ruby","application/x-sh","application/yaml","application/octet-stream"],i=xn(e);!a.some(S=>i.startsWith(S)||i===S||i==="")&&i!==""&&console.warn(`File type "${i}" might not be supported`);const l=new FileReader,d=await new Promise((S,p)=>{l.onload=()=>S(l.result),l.onerror=p,l.readAsDataURL(e)}),g=d.startsWith("data:")?d.replace(/^data:[^;]*/,`data:${i}`):d,y=S=>{const p=S.replace(/\\/g,"/").split("/");return p[p.length-1]||S},m={id:`file-${Date.now()}-${Math.random().toString(36).substring(2,9)}`,file:e,dataUrl:g,mimeType:i,filename:y(e.name),size:e.size,source:"local"};t(S=>({attachedFiles:[...S.attachedFiles,m]}))},addServerFile:async(e,s,r)=>{const o=it(e),{attachedFiles:a}=n();if(a.some(p=>it(p.serverPath||"")===o&&p.source==="server")){console.log(`Server file "${s}" is already attached`);return}const c=An(s),l=c&&c.trim().length>0?c:"application/octet-stream",d=l!=="text/plain"&&l!=="application/x-directory";let g=vn(o);if(d)try{g=await bn(o)}catch(p){console.warn("Failed to inline binary server file, falling back to file://",p)}const y=typeof r=="string"?new TextEncoder().encode(r).length:0,m=new File([],s,{type:l}),S={id:`server-file-${Date.now()}-${Math.random().toString(36).substring(2,9)}`,file:m,dataUrl:g,mimeType:l,filename:s,size:y,source:"server",serverPath:o};t(p=>({attachedFiles:[...p.attachedFiles,S]}))},removeAttachedFile:e=>{t(s=>({attachedFiles:s.attachedFiles.filter(r=>r.id!==e)}))},clearAttachedFiles:()=>{t({attachedFiles:[]})}}),{name:"file-store",storage:Ae(()=>de()),version:3,migrate:t=>{const n=t;return{attachedFiles:Array.isArray(n?.attachedFiles)?n.attachedFiles:[]}},partialize:t=>({attachedFiles:t.attachedFiles})}),{name:"file-store"})),Dn=new Set(["edit","multiedit","str_replace","str_replace_based_edit_tool","write"]),Cn=t=>t?Dn.has(t.toLowerCase()):!1,kn=()=>{if(!(typeof window>"u"))return window.__zustand_config_store__},Pn=t=>{if(t)try{const n=kn();if(n?.getState)return n.getState().agents?.find?.(s=>s.name===t)}catch{}},Tn=(t,n)=>{if(!t||t.length===0)return"ask";for(let e=t.length-1;e>=0;e-=1){const s=t[e];if(s.permission===n&&s.pattern==="*")return s.action}for(let e=t.length-1;e>=0;e-=1){const s=t[e];if(s.permission==="*"&&s.pattern==="*")return s.action}return"ask"},$e=t=>{const n=Pn(t);return n?Tn(n.permission,"edit"):"ask"},Tt=t=>{if(!t||typeof t!="object")return 0;const n=t.input??0,e=t.output??0,s=t.reasoning??0,r=t.cache&&typeof t.cache=="object"?t.cache.read??0:0,o=t.cache&&typeof t.cache=="object"?t.cache.write??0:0;return n+e+s+r+o},tt=t=>{const n=t.info.tokens;if(typeof n=="number")return n;if(n&&typeof n=="object")return Tt(n);const e=t.parts.find(s=>typeof s.tokens<"u");return!e||typeof e.tokens>"u"?0:typeof e.tokens=="number"?e.tokens:Tt(e.tokens)},st=(t,n,e)=>{const s=Number.isFinite(n)?Math.max(n,0):0,r=Number.isFinite(e)&&e>0,o=r?Math.max(e,0):0,a=Math.min(r?o:32e3,32e3),i=Math.min(a,s),c=s>0?Math.max(s-i,1):0,l=c>0?t/c*100:0;return{percentage:Math.min(l,100),contextLimit:s,outputLimit:o,thresholdLimit:c||1,normalizedOutput:i}},Ce=["ask","allow","full"],Et="__global__",L=ue()(ge(we((t,n)=>({sessionModelSelections:new Map,sessionAgentSelections:new Map,sessionAgentModelSelections:new Map,sessionAgentModelVariantSelections:new Map,currentAgentContext:new Map,sessionContextUsage:new Map,sessionAgentEditModes:new Map,hasHydrated:typeof window>"u",saveSessionModelSelection:(e,s,r)=>{t(o=>{const a=new Map(o.sessionModelSelections);return a.set(e,{providerId:s,modelId:r}),{sessionModelSelections:a}})},getSessionModelSelection:e=>{const{sessionModelSelections:s}=n();return s.get(e)||null},saveSessionAgentSelection:(e,s)=>{t(r=>{const o=new Map(r.sessionAgentSelections);o.set(e,s);const a=new Map(r.currentAgentContext);return a.set(e,s),{sessionAgentSelections:o,currentAgentContext:a}})},getSessionAgentSelection:e=>{const{sessionAgentSelections:s}=n();return s.get(e)||null},saveAgentModelForSession:(e,s,r,o)=>{t(a=>{const i=new Map(a.sessionAgentModelSelections);let c=i.get(e);return c?c=new Map(c):c=new Map,c.set(s,{providerId:r,modelId:o}),i.set(e,c),{sessionAgentModelSelections:i}})},getAgentModelForSession:(e,s)=>{const{sessionAgentModelSelections:r}=n(),o=r.get(e);return o&&o.get(s)||null},saveAgentModelVariantForSession:(e,s,r,o,a)=>{t(i=>{const c=new Map(i.sessionAgentModelVariantSelections);let l=c.get(e);l?l=new Map(l):l=new Map;let d=l.get(s);d?d=new Map(d):d=new Map;const g=`${r}/${o}`;return a===void 0?(d.delete(g),d.size===0?(l.delete(s),l.size===0?c.delete(e):c.set(e,l)):(l.set(s,d),c.set(e,l))):(d.set(g,a),l.set(s,d),c.set(e,l)),{sessionAgentModelVariantSelections:c}})},getAgentModelVariantForSession:(e,s,r,o)=>{const{sessionAgentModelVariantSelections:a}=n(),i=a.get(e);if(!i)return;const c=i.get(s);if(c)return c.get(`${r}/${o}`)},analyzeAndSaveExternalSessionChoices:async(e,s,r)=>{const{saveAgentModelForSession:o,saveAgentModelVariantForSession:a}=n(),i=new Map,c=(S,p)=>{if("mode"in S&&S.mode&&typeof S.mode=="string"&&s.find(w=>w.name===S.mode))return S.mode;if("agent"in S&&S.agent&&typeof S.agent=="string"&&s.find(w=>w.name===S.agent))return S.agent;if(S.providerID&&S.modelID){const f=s.find(w=>w.model?.providerID===S.providerID&&w.model?.modelID===S.modelID);if(f)return f.name}const{currentAgentContext:h}=n(),u=h.get(e);if(u&&s.find(f=>f.name===u))return u;if(p>0&&S.providerID&&S.modelID){const w=(r.get(e)||[]).filter(v=>v.info.role==="assistant").sort((v,M)=>v.info.time.created-M.info.time.created);for(let v=p-1;v>=0;v--){const A=w[v].info;if(A.providerID===S.providerID&&A.modelID===S.modelID){if(A.mode&&typeof A.mode=="string"&&s.find(b=>b.name===A.mode))return A.mode;const C=s.find(D=>D.model?.providerID===A.providerID&&D.model?.modelID===A.modelID);if(C)return C.name}}}return S.providerID&&S.modelID&&s.find(w=>w.name==="build")?"build":null},l=r.get(e)||[],d=l.filter(S=>S.info.role==="assistant"||S.info.role==="user").sort((S,p)=>S.info.time.created-p.info.time.created),g=l.filter(S=>S.info.role==="assistant").sort((S,p)=>S.info.time.created-p.info.time.created);let y,m;for(let S=0;S<d.length;S++){const p=d[S],{info:h}=p,u=h;if(u.role==="user"){const f=typeof u.mode=="string"&&u.mode.trim().length>0?u.mode:typeof u.agent=="string"&&u.agent.trim().length>0?u.agent:void 0,w=typeof u.model?.providerID=="string"&&u.model.providerID.trim().length>0?u.model.providerID:typeof u.providerID=="string"&&u.providerID.trim().length>0?u.providerID:void 0,v=typeof u.model?.modelID=="string"&&u.model.modelID.trim().length>0?u.model.modelID:typeof u.modelID=="string"&&u.modelID.trim().length>0?u.modelID:void 0;if(f&&w&&v&&s.find(M=>M.name===f)){const M={providerId:w,modelId:v,timestamp:h.time.created},A=i.get(f);(!A||M.timestamp>A.timestamp)&&i.set(f,M),typeof u.variant=="string"&&u.variant.trim().length>0&&a(e,f,w,v,u.variant)}y=typeof u.variant=="string"&&u.variant.trim().length>0?u.variant:void 0,m=u.model?.providerID&&u.model?.modelID?{providerID:u.model.providerID,modelID:u.model.modelID}:void 0;continue}if(u.providerID&&u.modelID){const f=c(u,g.indexOf(p));if(f&&s.find(w=>w.name===f)){y&&m&&m.providerID===u.providerID&&m.modelID===u.modelID&&a(e,f,u.providerID,u.modelID,y);const w={providerId:u.providerID,modelId:u.modelID,timestamp:h.time.created},v=i.get(f);(!v||w.timestamp>v.timestamp)&&i.set(f,w)}}y=void 0,m=void 0}for(const[S,p]of i)o(e,S,p.providerId,p.modelId);return i},getContextUsage:(e,s,r,o)=>{if(!e)return null;const a=st(0,s,r),i=a.contextLimit,c=a.normalizedOutput??0,l=a.thresholdLimit;if(i===0||l===0)return null;const g=(o.get(e)||[]).filter(w=>w.info.role==="assistant");if(g.length===0)return null;const y=g[g.length-1],m=y.info.id,S=w=>{const v=()=>{t(M=>{const A=M.sessionContextUsage.get(e);if(A&&A.totalTokens===w.totalTokens&&A.percentage===w.percentage&&A.contextLimit===w.contextLimit&&(A.outputLimit??0)===(w.outputLimit??0)&&(A.normalizedOutput??0)===(w.normalizedOutput??0)&&A.thresholdLimit===w.thresholdLimit&&A.lastMessageId===w.lastMessageId)return M;const C=new Map(M.sessionContextUsage);return C.set(e,w),{sessionContextUsage:C}})};typeof queueMicrotask=="function"?queueMicrotask(v):typeof window<"u"?window.setTimeout(v,0):setTimeout(v,0)},p=n().sessionContextUsage.get(e);if(p&&p.lastMessageId===m){const w=p.normalizedOutput??p.outputLimit??0,v=p.contextLimit!==i||w!==c||p.thresholdLimit!==l;if(v&&p.totalTokens>0){const M=p.totalTokens/l*100,A={totalTokens:p.totalTokens,percentage:Math.min(M,100),contextLimit:i,outputLimit:a.outputLimit,normalizedOutput:c,thresholdLimit:l,lastMessageId:m};return S(A),A}if(!v&&p.totalTokens>0)return p}const h=tt(y);if(h===0)return p||null;const u=st(h,s,r),f={totalTokens:h,percentage:u.percentage,contextLimit:u.contextLimit,outputLimit:u.outputLimit,normalizedOutput:u.normalizedOutput,thresholdLimit:u.thresholdLimit,lastMessageId:m};return S(f),f},updateSessionContextUsage:(e,s,r,o)=>{const i=(o.get(e)||[]).filter(g=>g.info.role==="assistant");if(i.length===0)return;const c=i[i.length-1],l=tt(c);if(l===0)return;const d=st(l,s,r);t(g=>{const y=new Map(g.sessionContextUsage);return y.set(e,{totalTokens:l,percentage:d.percentage,contextLimit:d.contextLimit,outputLimit:d.outputLimit,normalizedOutput:d.normalizedOutput,thresholdLimit:d.thresholdLimit,lastMessageId:c.info.id}),{sessionContextUsage:y}})},initializeSessionContextUsage:(e,s,r,o)=>{const i=n().sessionContextUsage.get(e);(!i||i.totalTokens===0)&&n().updateSessionContextUsage(e,s,r,o)},pollForTokenUpdates:(e,s,r,o=10)=>{let a=0;const i=()=>{a++;const l=(r.get(e)||[]).find(d=>d.info.id===s);if(l&&l.info.role==="assistant"&&tt(l)>0){n().updateSessionContextUsage(e,0,0,r);return}a<o&&setTimeout(i,1e3)};setTimeout(i,2e3)},getCurrentAgent:e=>{const{currentAgentContext:s}=n();return s.get(e)},getSessionAgentEditMode:(e,s,r=$e(s))=>{if(!e||!s)return r;const a=n().sessionAgentEditModes.get(e)?.get(s);if(a!==void 0)return a;if(e!==Et){const c=n().sessionAgentEditModes.get(Et)?.get(s);if(c!==void 0)return c}return r},setSessionAgentEditMode:(e,s,r,o=$e(s))=>{if(!e||!s)return;const a=o??"ask";a==="deny"||r==="deny"||Ce.includes(r)&&t(i=>{const c=new Map(i.sessionAgentEditModes),l=new Map(c.get(e)??new Map);return r===a?(l.delete(s),l.size===0?c.delete(e):c.set(e,l)):(l.set(s,r),c.set(e,l)),{sessionAgentEditModes:c}})},toggleSessionAgentEditMode:(e,s,r=$e(s))=>{if(!e||!s)return;const o=r??"ask";if(o==="deny")return;const a=n().getSessionAgentEditMode(e,s,o),i=Ce.indexOf(a),c=Ce.indexOf(o),d=((i>=0?i:c>=0?c:0)+1)%Ce.length,g=Ce[d];n().setSessionAgentEditMode(e,s,g,o)}}),{name:"context-store",storage:Ae(()=>de()),partialize:t=>({sessionModelSelections:Array.from(t.sessionModelSelections.entries()),sessionAgentSelections:Array.from(t.sessionAgentSelections.entries()),sessionAgentModelSelections:Array.from(t.sessionAgentModelSelections.entries()).map(([n,e])=>[n,Array.from(e.entries())]),sessionAgentModelVariantSelections:Array.from(t.sessionAgentModelVariantSelections.entries()).map(([n,e])=>[n,Array.from(e.entries()).map(([s,r])=>[s,Array.from(r.entries())])]),currentAgentContext:Array.from(t.currentAgentContext.entries()),sessionContextUsage:Array.from(t.sessionContextUsage.entries()),sessionAgentEditModes:Array.from(t.sessionAgentEditModes.entries()).map(([n,e])=>[n,Array.from(e.entries())])}),merge:(t,n)=>{const e=new Map;t?.sessionAgentModelSelections&&t.sessionAgentModelSelections.forEach(([o,a])=>{e.set(o,new Map(a))});const s=new Map;t?.sessionAgentModelVariantSelections&&t.sessionAgentModelVariantSelections.forEach(([o,a])=>{const i=new Map;a.forEach(([c,l])=>{i.set(c,new Map(l))}),s.set(o,i)});const r=new Map;return t?.sessionAgentEditModes&&t.sessionAgentEditModes.forEach(([o,a])=>{r.set(o,new Map(a))}),{...n,...t,sessionModelSelections:new Map(t?.sessionModelSelections||[]),sessionAgentSelections:new Map(t?.sessionAgentSelections||[]),sessionAgentModelSelections:e,sessionAgentModelVariantSelections:s,currentAgentContext:new Map(t?.currentAgentContext||[]),sessionContextUsage:new Map(t?.sessionContextUsage||[]),sessionAgentEditModes:r,hasHydrated:!0}}}),{name:"context-store"})),_t=(t,n)=>{const e=new Map(t);return e.delete(n),e};let nt=[],rt=null;const En=50,_n=3e4,ae=new Map,Oe=new Map,fe=new Map,In=10,Ge=t=>{if(typeof t!="string")return null;const n=t.trim();if(!n)return null;const e=n.indexOf("_"),s=e>=0?n.slice(e+1):n;return!s||s.length<In?null:s},Le=(t,n)=>{const e=Ge(t),s=Ge(n);return!e||!s||e.length!==s.length?!0:e>s},Fn=()=>{if(typeof window>"u")return!1;try{return window.localStorage.getItem("openchamber_stream_debug")==="1"}catch{return!1}},ye=t=>!Array.isArray(t)||t.length===0?0:t.reduce((n,e)=>{if(!e||e.type!=="text")return n;const s=e.text??e.content;return typeof s=="string"?n+s.length:n},0),It=t=>{const n=t.replace(/\\/g,"/").trim();if(n.startsWith("file://"))return n;const e=n.startsWith("/")?n:`/${n}`;return`file://${encodeURI(e)}`},He=t=>t?.finish==="stop",Ft=t=>{if(t){if(typeof t.id=="string"&&t.id.length>0)return t.id;if(t.type){const n=t.reason,e=t.callID;return`${t.type}-${n??""}-${e??""}`}}},Ut=new Set,Ve=(t=[],n=[])=>{if(!n.length)return[...t];const e=[...t],s=new Set(t.map(Ft).filter(r=>!!r));return n.forEach(r=>{if(!r)return;const o=Ft(r);o&&s.has(o)||(e.push(r),o&&s.add(o))}),e},Un=(t,n)=>{const e=Array.isArray(t.parts)?t.parts:[],s=Array.isArray(n.parts)?n.parts:[],r=ye(e),o=ye(s),a=He(t.info),i=He(n.info);let c=s;return a&&r>=o?c=Ve(e,s):i&&o>=r?c=Ve(s,e):r>=o&&(c=e),{...n,info:{...t.info,...n.info},parts:c}},ke=t=>{const n=[],e=new Map;for(const s of t){const r=typeof s?.info?.id=="string"?s.info.id:null;if(!r){n.push(s);continue}const o=e.get(r);if(o===void 0){e.set(r,n.length),n.push(s);continue}n[o]=Un(n[o],s)}return n},Rn=(t,n)=>{let e=n,s=n?Ge(n):null;for(const r of t){const o=r?.info?.id,a=Ge(o);!o||!a||(!s||a>s)&&(s=a,e=o)}return e},te=(t,n,e)=>{if(t.get(n)===e)return t;const r=new Map(t);return e?r.set(n,e):r.delete(n),r},pe=(t,n,e)=>{if(t.get(n)===e)return t;const r=new Map(t);return r.set(n,e),r},Be=(t,n)=>{const e=new Map(t);let s=!1;for(const r of n)e.delete(r)&&(s=!0);return s?e:t},jn=(t,n)=>{const e=new Set,s=t.streamingMessageIds.get(n);return s&&e.add(s),t.messageStreamStates.forEach((r,o)=>{t.messageSessionIndex.get(o)===n&&e.add(o)}),e},Rt=(t,n,e)=>t.streamingMessageIds.get(n)===e?!0:t.messageSessionIndex.get(e)===n&&t.messageStreamStates.has(e),On=async t=>{if(t)try{return I.getState().getDirectoryForSession(t)??void 0}catch(n){console.warn("Failed to resolve session directory override:",n);return}},jt=t=>{if(!t)return null;try{return I.getState().sessions.find(s=>s.id===t)?.revert?.messageID??null}catch{return null}},Ot=(t,n)=>{if(!n)return t;const e=t.findIndex(s=>s.info.id===n);return e===-1?t:t.slice(0,e)},ot=async(t,n)=>{const e=await On(t);return e?F.withDirectory(e,n):n()},B=ue()(ge(we((t,n)=>({messages:new Map,sessionMemoryState:new Map,messageStreamStates:new Map,messageSessionIndex:new Map,streamingMessageIds:new Map,abortControllers:new Map,lastUsedProvider:null,isSyncing:!1,pendingAssistantParts:new Map,sessionCompactionUntil:new Map,sessionAbortFlags:new Map,pendingAssistantHeaderSessions:new Set,pendingUserMessageMetaBySession:new Map,loadMessages:async(e,s)=>{const r=Mt(),o=s===1/0,a=n().sessionMemoryState.get(e),i=r.HISTORICAL_MESSAGES,c=a?.historyLimit,l=typeof s=="number"&&Number.isFinite(s)?s:Math.max(i,c??0),d=o?void 0:l+1,g=await ot(e,()=>F.getSessionMessages(e,d)),y=jt(e),m=Ot(g,y),S=typeof d=="number"?m.length>l:!1,p=n().sessionMemoryState.get(e)?.trimmedHeadMaxId,u=(p?m.filter(f=>{const w=f?.info?.id;return w?Le(w,p):!0}):m).slice(-l);t(f=>{const w=new Map(f.messages),v=f.messages.get(e)||[],M=new Map(v.filter(x=>typeof x.info?.id=="string").map(x=>[x.info.id,x])),A=u.map(x=>{const P={...x.info,clientRole:x.info?.clientRole??x.info.role,userMessageMarker:x.info.role==="user"?!0:x.info?.userMessageMarker},R=(Array.isArray(x.parts)?x.parts:[]).map(U=>{if(U?.type==="text"){const z=U.text??U.content??"";if(Ye(z))return{...U,synthetic:!0}}return U}),O=P?.id?M.get(P.id):void 0;if(O&&O.info.role==="assistant"){const U=Array.isArray(O.parts)?O.parts:[],z=ye(U),V=ye(R);if(He(O.info)&&z>V){const j=Ve(U,R);return{...x,info:P,parts:j}}}return{...x,info:P,parts:R}}),C=ke(A),D=new Set(v.map(x=>x.info.id)),b=new Set(C.map(x=>x.info.id)),k=[];D.forEach(x=>{b.has(x)||k.push(x)}),w.set(e,C);const T=new Map(f.sessionMemoryState);T.set(e,{...a,viewportAnchor:C.length-1,isStreaming:!1,lastAccessedAt:Date.now(),backgroundMessageCount:0,totalAvailableMessages:a?.totalAvailableMessages,hasMoreAbove:S,historyLoading:!1,historyComplete:!S,historyLimit:l,trimmedHeadMaxId:a?.trimmedHeadMaxId,streamingCooldownUntil:void 0});const _={messages:w,sessionMemoryState:T};ie(k);const W=be(f.messageStreamStates,k);if(W!==f.messageStreamStates&&(_.messageStreamStates=W),k.length>0){const x=f.streamingMessageIds.get(e);x&&k.includes(x)&&(_.streamingMessageIds=te(_.streamingMessageIds??f.streamingMessageIds,e,null))}if(k.length>0){const x=Be(_.messageSessionIndex??f.messageSessionIndex,k);x!==(_.messageSessionIndex??f.messageSessionIndex)&&(_.messageSessionIndex=x)}if(k.length>0){const x=new Map(f.pendingAssistantParts);let P=!1;k.forEach(R=>{x.delete(R)&&(P=!0)}),P&&(_.pendingAssistantParts=x)}const N=_.messageSessionIndex??f.messageSessionIndex;let $=N;return C.forEach(x=>{const P=x?.info?.id;typeof P=="string"&&P.length>0&&($=pe($,P,e))}),$!==N&&(_.messageSessionIndex=$),_})},sendMessage:async(e,s,r,o,a,i,c,l,d)=>{if(!a)throw new Error("No session selected");const g=a;n().sessionAbortFlags.has(g)&&t(y=>{const m=new Map(y.sessionAbortFlags);return m.delete(g),{sessionAbortFlags:m}}),await ot(g,async()=>{try{let y=e;if(e.startsWith("/")){const S=e.indexOf(" "),p=S===-1?e.substring(1):e.substring(1,S),h=S===-1?"":e.substring(S+1).trim(),u=F.getApiClient(),f=F.getDirectory();if(p==="init"){const w=`msg_${Date.now()}_${Math.random().toString(36).substring(2,9)}`;await u.session.init({sessionID:g,...f?{directory:f}:{},messageID:w,providerID:s,modelID:r});return}if(p==="summarize"){await u.session.summarize({sessionID:g,...f?{directory:f}:{},providerID:s,modelID:r});return}try{const w=await F.getCommandDetails(p);w?.template?y=w.template.replace(/\$ARGUMENTS/g,h):y=e}catch(w){console.error("Command template resolution failed:",w),y=e}}t({lastUsedProvider:{providerID:s,modelID:r}}),t(S=>{const p=S.sessionMemoryState.get(g)||{viewportAnchor:0,isStreaming:!1,lastAccessedAt:Date.now(),backgroundMessageCount:0},h=fe.get(g);h&&(clearTimeout(h),fe.delete(g));const u=new Map(S.sessionMemoryState);return u.set(g,{...p,isStreaming:!0,streamStartTime:Date.now(),streamingCooldownUntil:void 0}),{sessionMemoryState:u}});try{const S=new AbortController;t(u=>{const f=new Map(u.abortControllers);return f.set(g,S),{abortControllers:f}});const p=(i??[]).map(u=>({type:"file",mime:u.mimeType,filename:u.filename,url:u.source==="server"&&u.serverPath&&(u.mimeType==="text/plain"||u.mimeType==="application/x-directory")?It(u.serverPath):u.dataUrl}));t(u=>{const f=new Set(u.pendingAssistantHeaderSessions);f.add(g);const w=new Map(u.pendingUserMessageMetaBySession);return w.set(g,{mode:typeof o=="string"&&o.trim().length>0?o.trim():void 0,providerID:s,modelID:r,variant:typeof d=="string"&&d.trim().length>0?d:void 0}),{pendingAssistantHeaderSessions:f,pendingUserMessageMetaBySession:w}});const h=l?.map(u=>({text:u.text,synthetic:u.synthetic,files:u.attachments?.map(f=>({type:"file",mime:f.mimeType,filename:f.filename,url:f.source==="server"&&f.serverPath&&(f.mimeType==="text/plain"||f.mimeType==="application/x-directory")?It(f.serverPath):f.dataUrl}))}));if(await F.sendMessage({id:g,providerID:s,modelID:r,text:y,agent:o,variant:d,files:p.length>0?p:void 0,additionalParts:h&&h.length>0?h:void 0,agentMentions:c?[{name:c}]:void 0}),p.length>0)try{ce.getState().clearAttachedFiles()}catch(u){console.error("Failed to clear attached files after send",u)}t(u=>{const f=new Map(u.abortControllers);return f.delete(g),{abortControllers:f}})}catch(S){let p="Network error while sending message. The message may still be processing.";if(S.name==="AbortError")p="Request timed out. The message may still be processing.";else if(S.message?.includes("504")||S.message?.includes("Gateway")){p="Gateway timeout - your message is being processed. Please wait for response.",t(h=>{const u=new Map(h.abortControllers);return u.delete(g),{abortControllers:u}});return}else S.message&&(p=S.message);throw t(h=>{const u=new Map(h.abortControllers);u.delete(g);const f=new Set(h.pendingAssistantHeaderSessions);f.delete(g);const w=new Map(h.pendingUserMessageMetaBySession);return w.delete(g),{abortControllers:u,pendingAssistantHeaderSessions:f,pendingUserMessageMetaBySession:w}}),new Error(p)}}catch(y){let m="Network error while sending message. The message may still be processing.";throw y.name==="AbortError"?m="Request timed out. The message may still be processing.":y.response?.status===401?m="Session not found or unauthorized. Please refresh the page.":y.response?.status===502?m="OpenCode is restarting. Please wait a moment and try again.":y.message?.includes("504")||y.message?.includes("Gateway")?m="Gateway timeout - your message is being processed. Please wait for response.":y.message&&(m=y.message),t(S=>{const p=new Map(S.abortControllers);p.delete(g);const h=new Set(S.pendingAssistantHeaderSessions);h.delete(g);const u=new Map(S.pendingUserMessageMetaBySession);return u.delete(g),{abortControllers:p,pendingAssistantHeaderSessions:h,pendingUserMessageMetaBySession:u}}),new Error(m)}})},abortCurrentOperation:async e=>{if(!e)return;const s=n(),{abortControllers:r,messages:o}=s;r.get(e)?.abort();const i=jn(s,e);if(i.size===0){const l=e?o.get(e)??[]:[];let d=null;for(let g=l.length-1;g>=0;g-=1){const y=l[g];if(!y||y.info.role!=="assistant")continue;if(d||(d=y.info.id),(y.parts??[]).some(S=>S.type==="reasoning"||S.type==="tool"||S.type==="step-start")){i.add(y.info.id);break}}i.size===0&&d&&i.add(d)}for(const l of i){const d=ae.get(l);d&&(clearTimeout(d),ae.delete(l),Oe.delete(l))}i.size>0&&ie(i);const c=Date.now();t(l=>{const d=be(l.messageStreamStates,i),g=l.messages.get(e)??[];let y=!1,m=l.messages;if(g.length>0&&i.size>0){const u=g.map(f=>{if(!i.has(f.info.id)&&i.size>0)return f;const w=(f.parts??[]).map(v=>{if(v.type==="reasoning"){const M=v,A={...M.time??{}};return typeof A.end!="number"&&(A.end=c),{...M,time:A}}if(v.type==="tool"){const M=v,A={...M.state??{}};return(A.status==="running"||A.status==="pending")&&(A.status="aborted"),{...M,state:A}}return v.type==="step-start"?{...v,type:"step-finish",aborted:!0}:v});return y=!0,{...f,info:{...f.info,abortedAt:c,streaming:!1,status:"aborted"},parts:w}});y&&(m=new Map(l.messages),m.set(e,u))}const S=l.sessionMemoryState.get(e);let p=l.sessionMemoryState;if(S){const u=new Map(l.sessionMemoryState);u.set(e,{...S,isStreaming:!1,streamStartTime:void 0,isZombie:!1}),p=u}const h=new Map(l.sessionAbortFlags);return h.set(e,{timestamp:c,acknowledged:!1}),{messageStreamStates:d,sessionMemoryState:p,sessionAbortFlags:h,abortControllers:(()=>{const u=new Map(l.abortControllers);return u.delete(e),u})(),streamingMessageIds:te(l.streamingMessageIds,e,null),...y?{messages:m}:{}}}),F.abortSession(e).catch(l=>{console.warn("Abort request failed:",l)})},_addStreamingPartImmediate:(e,s,r,o,a)=>{const i=n();if(Ut.has(s))return;const c=i.sessionMemoryState.get(e)?.trimmedHeadMaxId;if(c&&!Le(s,c)){window.__messageTracker?.(s,"ignored_trimmed_stream_part");return}const l=i.messages.get(e)||[],d=l.find(m=>m.info.id===s),g=o==="user"||d?.info.role==="user"?"user":o||d?.info.role||"assistant",y=n().sessionMemoryState.get(e);if(y?.streamStartTime&&Date.now()-y.streamStartTime>We.ZOMBIE_TIMEOUT){y.isZombie||t(S=>{const p=new Map(S.sessionMemoryState);return p.set(e,{...y,isZombie:!0}),{sessionMemoryState:p}}),setTimeout(()=>{n().completeStreamingMessage(e,s)},0),window.__messageTracker?.(s,"skipped_zombie_stream");return}t(m=>{const p=[...m.messages.get(e)||[]],h={},u=pe(m.messageSessionIndex,s,e);u!==m.messageSessionIndex&&(h.messageSessionIndex=u);const f=b=>{if(!((g==="assistant"||g==="user")&&m.sessionAbortFlags.has(e)))return b;const T=new Map(m.sessionAbortFlags);return T.delete(e),{...b,sessionAbortFlags:T}},w=b=>{const k=b||"",T=Oe.get(s);if(k&&T===k){const N=n();if(Rt(N,e,s)){const $=ae.get(s);$&&(clearTimeout($),ae.delete(s)),setTimeout(()=>{const x=n();typeof x.forceCompleteMessage=="function"&&x.forceCompleteMessage(e,s,"timeout"),x.completeStreamingMessage(e,s)},100)}}Oe.set(s,k);const _=ae.get(s);_&&clearTimeout(_);const W=setTimeout(()=>{const N=n();typeof N.forceCompleteMessage=="function"&&N.forceCompleteMessage(e,s,"timeout"),Rt(N,e,s)&&N.completeStreamingMessage(e,s),ae.delete(s),Oe.delete(s)},8e3);ae.set(s,W)},v=e!==a,M=m.sessionMemoryState.get(e);if(v&&M?.isStreaming){p.length>=We.BACKGROUND_STREAMING_BUFFER&&p.shift();const b=new Map(m.sessionMemoryState);b.set(e,{...M,backgroundMessageCount:(M.backgroundMessageCount||0)+1}),m.sessionMemoryState=b}if(g==="assistant"){const b=m.sessionMemoryState.get(e);if(b){const k=Date.now(),T=new Map(m.sessionMemoryState);T.set(e,{...b,isStreaming:!0,streamStartTime:b.streamStartTime??k,lastAccessedAt:k,isZombie:!1}),m.sessionMemoryState=T}}const A=Se(r);if(Ye(A)&&(r.synthetic=!0),Fn()&&g==="assistant")try{console.info("[STREAM-TRACE] part",{messageId:s,role:g,type:r?.type||"text",textLen:A.length,snapshotParts:l.length})}catch{}const C=h.streamingMessageIds??m.streamingMessageIds;if(g==="assistant"){const b=te(C,e,s);b!==C&&(h.streamingMessageIds=b,window.__messageTracker?.(s,"streamingId_set_latest"))}const D=p.findIndex(b=>b.info.id===s);if(D!==-1&&g==="user"){const b=p[D],k=b.parts.findIndex($=>$.id===r.id);if(r.synthetic===!0){const $=Se(r).trim();if(!($.startsWith("User has requested to enter plan mode")||$.startsWith("The plan at ")))return window.__messageTracker?.(s,"skipped_synthetic_user_part"),m}const T=De(r,k!==-1?b.parts[k]:void 0);window.__messageTracker?.(s,`user_part_type:${T.type||"unknown"}`);const _={...b};k!==-1?_.parts=_.parts.map(($,x)=>x===k?T:$):_.parts=[..._.parts,T];const W=[...p];W[D]=_;const N=new Map(m.messages);return N.set(e,W),f({messages:N})}if(g==="assistant"&&D!==-1){const b=p[D],k=b.parts.findIndex(x=>x.id===r.id),T=De(r,k!==-1?b.parts[k]:void 0);window.__messageTracker?.(s,`part_type:${T.type||"unknown"}`);const _={...b};k!==-1?_.parts=_.parts.map((x,P)=>P===k?T:x):_.parts=[..._.parts,T];const W=[...p];W[D]=_;const N=new Map(m.messages);N.set(e,W),h.messageStreamStates=et(m.messageStreamStates,s);const $=te(h.streamingMessageIds??m.streamingMessageIds,e,s);return $!==(h.streamingMessageIds??m.streamingMessageIds)&&(h.streamingMessageIds=$,window.__messageTracker?.(s,"streamingId_set")),T.type==="text"?w(T.text||""):w(""),f({messages:N,...h})}if(D===-1){if(g==="user"){if(r.synthetic===!0){const Re=Se(r).trim();if(!(Re.startsWith("User has requested to enter plan mode")||Re.startsWith("The plan at ")))return window.__messageTracker?.(s,"skipped_synthetic_new_user_part"),m}const H=De(r);window.__messageTracker?.(s,`new_user_part_type:${H.type||"unknown"}`);const Z=m.pendingUserMessageMetaBySession.get(e),re=L.getState(),xe=Z?.mode??re.getSessionAgentSelection(e)??re.getCurrentAgent(e),mt=typeof xe=="string"&&xe.trim().length>0?xe.trim():void 0,ft=Z?.providerID??(m.lastUsedProvider?.providerID||void 0),pt=Z?.modelID??(m.lastUsedProvider?.modelID||void 0);Z&&(h.pendingUserMessageMetaBySession=_t(m.pendingUserMessageMetaBySession,e));const os={info:{id:s,sessionID:e,role:"user",clientRole:"user",userMessageMarker:!0,...mt?{mode:mt}:{},...ft?{providerID:ft}:{},...pt?{modelID:pt}:{},time:{created:Date.now()}},parts:[H]},St=[...p,os];St.sort((Re,ht)=>{const is=Re.info?.time?.created||0,as=ht.info?.time?.created||0;return is-as});const yt=new Map(m.messages);return yt.set(e,St),f({messages:yt})}if(r?.type==="text"){const H=Se(r).trim();if(H.length>0){const Z=[...p].reverse().find(re=>re.info.role==="user");if(Z){const re=Z.parts.map(xe=>Se(xe)).join("").trim();if(re.length>0&&re===H)return Ut.add(s),window.__messageTracker?.(s,"ignored_assistant_echo"),m}}}const b=De(r);window.__messageTracker?.(s,`part_type:${b.type||"unknown"}`),b.type==="text"?w(b.text||""):w("");const k=m.pendingAssistantParts.get(s),T=k?[...k.parts]:[],_=T.findIndex(H=>H.id===b.id);_!==-1?T[_]=b:T.push(b);const W=new Map(m.pendingAssistantParts);W.set(s,{sessionId:e,parts:T});const N=m.lastUsedProvider?.providerID||"",$=m.lastUsedProvider?.modelID||"",x=Date.now(),P=F.getDirectory()??"/",R=L.getState(),O=R.getSessionAgentSelection(e)??R.getCurrentAgent(e),U=typeof O=="string"&&O.trim().length>0?O.trim():void 0,z=m.pendingAssistantHeaderSessions.has(e);if(z){const H=new Set(m.pendingAssistantHeaderSessions);H.delete(e),h.pendingAssistantHeaderSessions=H}const G={info:g==="user"?{id:s,sessionID:e,role:"user",time:{created:x},agent:U||"default",model:{providerID:N,modelID:$},clientRole:g,animationSettled:void 0,streaming:void 0}:{id:s,sessionID:e,role:"assistant",time:{created:x},parentID:s,modelID:$,providerID:N,mode:U||"default",...z?{openchamberHeaderAnchor:!0}:{},path:{cwd:P,root:P},cost:0,tokens:{input:0,output:0,reasoning:0,cache:{read:0,write:0}},clientRole:g,animationSettled:!1,streaming:!0},parts:T},j=[...p,G],X=new Map(m.messages);if(X.set(e,j),g==="assistant"){h.messageStreamStates=et(m.messageStreamStates,s);const H=te(h.streamingMessageIds??m.streamingMessageIds,e,s);H!==(h.streamingMessageIds??m.streamingMessageIds)&&(h.streamingMessageIds=H,window.__messageTracker?.(s,"streamingId_set"))}return f({messages:X,pendingAssistantParts:W,...h})}else{const b=p[D],k=b.parts.findIndex($=>$.id===r.id),T=De(r,k!==-1?b.parts[k]:void 0);window.__messageTracker?.(s,`part_type:${T.type||"unknown"}`);const _={...b};k!==-1?_.parts=_.parts.map(($,x)=>x===k?T:$):_.parts=[..._.parts,T];const W=[...p];W[D]=_;const N=new Map(m.messages);if(N.set(e,W),_.info.role==="assistant"){h.messageStreamStates=et(m.messageStreamStates,s);const $=te(h.streamingMessageIds??m.streamingMessageIds,e,s);$!==(h.streamingMessageIds??m.streamingMessageIds)&&(h.streamingMessageIds=$,window.__messageTracker?.(s,"streamingId_set"))}return T.type==="text"?w(T.text||""):w(""),f({messages:N,...h})}})},addStreamingPart:(e,s,r,o,a)=>{if(o!=="user"){n()._addStreamingPartImmediate(e,s,r,o,a);return}nt.push({sessionId:e,messageId:s,part:r,role:o,currentSessionId:a}),rt||(rt=setTimeout(()=>{const i=[...nt];nt=[],rt=null;const c=n();for(const l of i)c._addStreamingPartImmediate(l.sessionId,l.messageId,l.part,l.role,l.currentSessionId)},En))},forceCompleteMessage:(e,s,r="timeout")=>{const o=a=>{if(e)return e;for(const[i,c]of a.messages.entries())if(c.some(l=>l.info.id===s))return i;return null};t(a=>{const i=o(a);if(!i)return a;const c=a.messages.get(i)??[],l=c.findIndex(M=>M.info.id===s);if(l===-1)return a;const d=c[l];if(!d)return a;const g=Date.now(),y=d.info,m=typeof y?.time?.completed=="number"&&y.time.completed>0;let S=!1;const p={...y};m||(p.time={...y.time??{},completed:g},S=!0),p.status!=="completed"&&(p.status="completed",S=!0),p.streaming&&(p.streaming=!1,S=!0);let h=!1;const u=d.parts.map(M=>{if(!M)return M;if(M.type==="tool"){const A=M.state;if(!A)return M;const C=A.status,D=C==="running"||C==="pending"||C==="started",b=!A.time||typeof A.time?.end!="number";if(D||b){const k={...A};return D&&(k.status="completed"),b&&(k.time={...A.time??{},end:g}),h=!0,{...M,state:k}}return M}if(M.type==="reasoning"){const A=M.time;return!A||typeof A.end!="number"?(h=!0,{...M,time:{...A??{},end:g}}):M}if(M.type==="text"){const A=M.time;return A&&typeof A.end!="number"?(h=!0,{...M,time:{...A,end:g}}):M}return M});if(!S&&!h)return a;window.__messageTracker?.(s,`force_complete:${r}`);const f={...d,info:p,parts:h?u:d.parts},w=[...c];w[l]=f;const v=new Map(a.messages);return v.set(i,w),{messages:v}})},markMessageStreamSettled:e=>{t(s=>{rs(e);const r=new Map(s.messageStreamStates);r.delete(e);let o=s.messages,a=!1;return s.messages.forEach((c,l)=>{if(a)return;const d=c.findIndex(p=>p.info.id===e);if(d===-1)return;const g=c[d];if(g.info?.animationSettled)return;const y={...g,info:{...g.info,animationSettled:!0}},m=[...c];m[d]=y;const S=new Map(s.messages);S.set(l,m),o=S,a=!0}),{messageStreamStates:r,...a?{messages:o}:{}}}),ie([e])},updateMessageInfo:(e,s,r)=>{t(i=>{const c=i.sessionMemoryState.get(e)?.trimmedHeadMaxId;if(c&&!Le(s,c))return window.__messageTracker?.(s,"ignored_trimmed_update"),i;const d=[...i.messages.get(e)??[]],g=d.findIndex(D=>D.info.id===s),y=i.pendingAssistantParts.get(s),m=(D=[],b=[])=>{if(!b.length)return D;const k=[...D];return b.forEach(T=>{const _=k.findIndex(W=>W.id===T.id);_===-1?k.push(T):k[_]=T}),k},S=D=>{if(!D)return D;const b=D.clientRole??D.role,k=b==="user"?!0:D.userMessageMarker;return{...D,clientRole:b,...k?{userMessageMarker:!0}:{}}};if(g===-1){if(console.info("[MESSAGE-DEBUG] updateMessageInfo: messageIndex === -1",{sessionId:e,messageId:s,messageInfo:r,existingCount:d.length}),d.length>0){const P=d[0]?.info,R=typeof P?.time?.created=="number"?P.time.created:null,O=typeof P?.id=="string"?P.id:null,U=r,z=typeof U?.time?.created=="number"?U.time.created:null,V=typeof U?.id=="string"?U.id:s;let G=!1;if(z!==null&&R!==null&&(G=z<R),!G&&V&&O&&(G=V.localeCompare(O)<0),G)return window.__messageTracker?.(s,"skipped_evicted_message_update"),i}const D=S(r);if(D&&D.role==="user"){const x=y?.parts??[],P=i.pendingUserMessageMetaBySession.get(e),R={info:{...D,userMessageMarker:!0,clientRole:"user",...P?.mode?{mode:P.mode}:{},...P?.providerID?{providerID:P.providerID}:{},...P?.modelID?{modelID:P.modelID}:{}},parts:x.length>0?[...x]:[]},O=new Map(i.messages),U=[...d,R];U.sort((G,j)=>{const X=G.info?.time?.created||0,H=j.info?.time?.created||0;return X-H}),O.set(e,U);const z={messages:O,...P?{pendingUserMessageMetaBySession:_t(i.pendingUserMessageMetaBySession,e)}:{}},V=pe(z.messageSessionIndex??i.messageSessionIndex,s,e);if(V!==(z.messageSessionIndex??i.messageSessionIndex)&&(z.messageSessionIndex=V),y){const G=new Map(i.pendingAssistantParts);G.delete(s),z.pendingAssistantParts=G}return z}if(!D||D.role!=="assistant")return i;const b=y?.parts??[],k=i.pendingAssistantHeaderSessions.has(e),T={info:{...D,animationSettled:D?.animationSettled??!1,...k?{openchamberHeaderAnchor:!0}:{}},parts:b.length>0?[...b]:[]},_=new Map(i.messages),W=[...d,T];_.set(e,W);const N={messages:_,...k?{pendingAssistantHeaderSessions:(()=>{const x=new Set(i.pendingAssistantHeaderSessions);return x.delete(e),x})()}:{}},$=pe(N.messageSessionIndex??i.messageSessionIndex,s,e);if($!==(N.messageSessionIndex??i.messageSessionIndex)&&(N.messageSessionIndex=$),y){const x=new Map(i.pendingAssistantParts);x.delete(s),N.pendingAssistantParts=x}return N}const p=d[g],h=p.info;if(h.userMessageMarker===!0||h.clientRole==="user"||h.role==="user"){const D={...p.info,...r,role:"user",clientRole:"user",userMessageMarker:!0,providerID:h.providerID||void 0,modelID:h.modelID||void 0},b=i.pendingUserMessageMetaBySession.get(e);b&&!D.mode&&b.mode&&(D.mode=b.mode);const k={...p,info:D},T=new Map(i.messages),_=[...d];if(_[g]=k,T.set(e,_),b){const W=new Map(i.pendingUserMessageMetaBySession);return W.delete(e),{messages:T,pendingUserMessageMetaBySession:W}}return{messages:T}}const f={...p.info,...r};r.role&&r.role!==p.info.role&&(f.role=p.info.role),f.clientRole=f.clientRole??p.info.clientRole??p.info.role,f.clientRole==="user"&&(f.userMessageMarker=!0);const w=y?.parts?m(p.parts,y.parts):p.parts,v={...p,info:f,parts:w},M=new Map(i.messages),A=[...d];A[g]=v,M.set(e,A);const C={messages:M};if(y){const D=new Map(i.pendingAssistantParts);D.delete(s),C.pendingAssistantParts=D}return C});const o=r?.finish,a=r?.role;typeof o=="string"&&a!=="user"&&setTimeout(()=>{n().completeStreamingMessage(e,s)},0)},completeStreamingMessage:(e,s)=>{const r=n();window.__messageTracker?.(s,`completion_called_current:${r.streamingMessageIds.get(e)??"none"}`),typeof r.forceCompleteMessage=="function"&&r.forceCompleteMessage(e,s,"cooldown");const o=r.streamingMessageIds.get(e)===s;o?window.__messageTracker?.(s,"streamingId_cleared"):window.__messageTracker?.(s,"streamingId_NOT_cleared_different_id");const a={};if(o&&(a.streamingMessageIds=te(r.streamingMessageIds,e,null),a.abortControllers=(()=>{const c=new Map(r.abortControllers);return c.delete(e),c})()),r.messageStreamStates.has(s)){const c=new Map(r.messageStreamStates);c.delete(s),a.messageStreamStates=c}Object.keys(a).length>0&&t(a),r.pendingAssistantParts.has(s)&&t(c=>{if(!c.pendingAssistantParts.has(s))return c;const l=new Map(c.pendingAssistantParts);return l.delete(s),{pendingAssistantParts:l}}),ie([s]);let i=!1;if(t(c=>{const l=c.sessionMemoryState.get(e);if(!l||!l.isStreaming)return c;const d=new Map(c.sessionMemoryState),g=Date.now(),y={...l,isStreaming:!1,streamStartTime:void 0,isZombie:!1,lastAccessedAt:g,streamingCooldownUntil:g+2e3};return d.set(e,y),i=!0,{sessionMemoryState:d}}),i){const c=fe.get(e);c&&(clearTimeout(c),fe.delete(e));const l=setTimeout(()=>{t(d=>{const g=d.sessionMemoryState.get(e);if(!g||g.isStreaming)return d;const y=new Map(d.sessionMemoryState),{streamingCooldownUntil:m,...S}=g;return y.set(e,S),{sessionMemoryState:y}}),fe.delete(e)},2e3);fe.set(e,l)}},syncMessages:(e,s)=>{const r=jt(e),o=Ot(s,r),a=n().sessionMemoryState.get(e)?.trimmedHeadMaxId,i=a?o.filter(c=>{const l=c?.info?.id;return l?Le(l,a):!0}):o;t(c=>{const l=new Map(c.messages),d=c.messages.get(e)||[],g=new Map(d.filter(M=>typeof M.info?.id=="string").map(M=>[M.info.id,M])),y=i.map(M=>{const A={...M.info,clientRole:M.info?.clientRole??M.info.role,userMessageMarker:M.info.role==="user"?!0:M.info?.userMessageMarker,animationSettled:M.info.role==="assistant"?M.info?.animationSettled??!0:M.info?.animationSettled},C=(Array.isArray(M.parts)?M.parts:[]).map(k=>{if(k?.type==="text"){const T=k.text??k.content??"";if(Ye(T))return{...k,synthetic:!0}}return k}),D=typeof A?.id=="string"?A.id:void 0,b=D?g.get(D):void 0;if(b&&b.info.role==="assistant"){const k=Array.isArray(b.parts)?b.parts:[],T=ye(k),_=ye(C);if(He(b.info)&&T>_){const N=Ve(k,C);return{...M,info:A,parts:N}}}return{...M,info:A,parts:C}}),m=ke(y),S=new Set(d.map(M=>M.info.id)),p=new Set(m.map(M=>M.info.id)),h=[];S.forEach(M=>{p.has(M)||h.push(M)}),l.set(e,m);const u={messages:l,isSyncing:!0};ie(h);const f=be(c.messageStreamStates,h);if(f!==c.messageStreamStates&&(u.messageStreamStates=f),h.length>0){const M=c.streamingMessageIds.get(e);M&&h.includes(M)&&(u.streamingMessageIds=te(u.streamingMessageIds??c.streamingMessageIds,e,null))}if(h.length>0){const M=Be(u.messageSessionIndex??c.messageSessionIndex,h);M!==(u.messageSessionIndex??c.messageSessionIndex)&&(u.messageSessionIndex=M)}if(h.length>0){const M=new Map(c.pendingAssistantParts);let A=!1;h.forEach(C=>{M.delete(C)&&(A=!0)}),A&&(u.pendingAssistantParts=M)}const w=u.messageSessionIndex??c.messageSessionIndex;let v=w;return m.forEach(M=>{const A=M?.info?.id;typeof A=="string"&&A.length>0&&(v=pe(v,A,e))}),v!==w&&(u.messageSessionIndex=v),u}),setTimeout(()=>{t({isSyncing:!1})},100)},updateSessionCompaction:(e,s)=>{t(r=>{const o=new Map(r.sessionCompactionUntil);if(!s||s<=0)return o.has(e)?(o.delete(e),{sessionCompactionUntil:o}):r;const a=s+_n;return o.get(e)===a?r:(o.set(e,a),{sessionCompactionUntil:o})})},acknowledgeSessionAbort:e=>{e&&t(s=>{const r=s.sessionAbortFlags.get(e);if(!r||r.acknowledged)return s;const o=new Map(s.sessionAbortFlags);return o.set(e,{...r,acknowledged:!0}),{sessionAbortFlags:o}})},updateViewportAnchor:(e,s)=>{t(r=>{const o=r.sessionMemoryState.get(e)||{viewportAnchor:0,isStreaming:!1,lastAccessedAt:Date.now(),backgroundMessageCount:0},a=new Map(r.sessionMemoryState);return a.set(e,{...o,viewportAnchor:s}),{sessionMemoryState:a}})},trimToViewportWindow:(e,s,r)=>{const o=s??lt(),a=n(),i=a.messages.get(e);if(!i||i.length<=o)return;const c=a.sessionMemoryState.get(e)||{viewportAnchor:i.length-1,isStreaming:!1,lastAccessedAt:Date.now(),backgroundMessageCount:0};if(c.isStreaming&&e===r)return;const l=c.viewportAnchor||i.length-1;let d=Math.max(0,l-Math.floor(o/2));const g=Math.min(i.length,d+o);g===i.length&&g-d<o&&(d=Math.max(0,g-o));const y=i.slice(d,g),m=i.slice(0,d),S=new Set(y.map(h=>h.info.id)),p=i.filter(h=>!S.has(h.info.id)).map(h=>h.info.id);t(h=>{const u=new Map(h.messages);u.set(e,y);const f=new Map(h.sessionMemoryState),w={...c,viewportAnchor:l-d,hasMoreAbove:!!c.hasMoreAbove||d>0,trimmedHeadMaxId:Rn(m,c.trimmedHeadMaxId)};f.set(e,w);const v={messages:u,sessionMemoryState:f};ie(p);const M=be(h.messageStreamStates,p);if(M!==h.messageStreamStates&&(v.messageStreamStates=M),p.length>0){const D=h.streamingMessageIds.get(e);D&&p.includes(D)&&(v.streamingMessageIds=te(v.streamingMessageIds??h.streamingMessageIds,e,null))}if(p.length>0){const D=Be(v.messageSessionIndex??h.messageSessionIndex,p);D!==(v.messageSessionIndex??h.messageSessionIndex)&&(v.messageSessionIndex=D)}const A=v.messageSessionIndex??h.messageSessionIndex;let C=A;return y.forEach(D=>{const b=D?.info?.id;typeof b=="string"&&b.length>0&&(C=pe(C,b,e))}),C!==A&&(v.messageSessionIndex=C),v})},evictLeastRecentlyUsed:e=>{const s=n();if(s.messages.size<=We.MAX_SESSIONS)return;const o=[];s.messages.forEach((c,l)=>{const d=s.sessionMemoryState.get(l)||{viewportAnchor:0,isStreaming:!1,lastAccessedAt:0,backgroundMessageCount:0};o.push([l,d])});const a=o.filter(([c,l])=>c!==e&&!l.isStreaming);if(a.length===0)return;a.sort((c,l)=>c[1].lastAccessedAt-l[1].lastAccessedAt);const i=a[0][0];t(c=>{const d=(c.messages.get(i)||[]).map(v=>v.info.id),g=new Map(c.messages),y=new Map(c.sessionMemoryState);g.delete(i);const m={messages:g,sessionMemoryState:y},S=new Map(c.pendingAssistantParts);let p=!1;S.forEach((v,M)=>{v.sessionId===i&&(S.delete(M),p=!0)}),p&&(m.pendingAssistantParts=S);const h=new Map(c.sessionCompactionUntil);h.delete(i)&&(m.sessionCompactionUntil=h),ie(d);const u=be(c.messageStreamStates,d);u!==c.messageStreamStates&&(m.messageStreamStates=u);const f=Be(m.messageSessionIndex??c.messageSessionIndex,d);f!==(m.messageSessionIndex??c.messageSessionIndex)&&(m.messageSessionIndex=f);const w=te(c.streamingMessageIds,i,null);if(w!==c.streamingMessageIds&&(m.streamingMessageIds=w),c.abortControllers.has(i)){const v=new Map(c.abortControllers);v.delete(i),m.abortControllers=v}return m})},loadMoreMessages:async(e,s="up")=>{const r=n(),o=r.messages.get(e),a=r.sessionMemoryState.get(e);if(!o||!a||a.historyLoading)return;const i=Mt(),c=a.historyLimit??Math.max(i.HISTORICAL_MESSAGES+i.FETCH_BUFFER,o.length+i.FETCH_BUFFER),l=s==="up"?c+i.HISTORY_CHUNK:c;t(d=>{const g=new Map(d.sessionMemoryState),y=g.get(e);return y?(g.set(e,{...y,historyLoading:!0,historyLimit:l}),{sessionMemoryState:g}):d});try{const d=l+1,g=await ot(e,()=>F.getSessionMessages(e,d));if(s==="up"&&o.length>0){const y=ke(g),m=g.length>=d,S=o[0],p=y.findIndex(h=>h.info.id===S.info.id);if(p>0){const h=Math.min(i.HISTORY_CHUNK,p),u=y.slice(p-h,p);t(f=>{const w=f.messages.get(e)??o,v=f.sessionMemoryState.get(e)??a,M=[...u,...w],A=ke(M),C=Math.max(0,A.length-w.length),D=new Map(f.messages);D.set(e,A);const b=new Map(f.sessionMemoryState);return b.set(e,{...v,viewportAnchor:v.viewportAnchor+C,hasMoreAbove:p-h>0||m,historyLoading:!1,historyLimit:l,historyComplete:!(p-h>0||m),totalAvailableMessages:Math.max(v.totalAvailableMessages??0,y.length)}),{messages:D,sessionMemoryState:b}});return}if(p===0){t(h=>{const u=h.sessionMemoryState.get(e)??a,f=new Map(h.sessionMemoryState);return f.set(e,{...u,hasMoreAbove:m,historyLoading:!1,historyLimit:l,historyComplete:!m,totalAvailableMessages:Math.max(u.totalAvailableMessages??0,y.length)}),{sessionMemoryState:f}});return}if(p<0){t(h=>{const u=h.messages.get(e)??o,f=h.sessionMemoryState.get(e)??a,w=new Set(u.map(k=>k.info.id)),v=y.filter(k=>!w.has(k.info.id)),M=ke([...v,...u]),A=Math.max(0,M.length-u.length),C=v.length>0||m,D=new Map(h.messages);A>0&&D.set(e,M);const b=new Map(h.sessionMemoryState);return b.set(e,{...f,viewportAnchor:f.viewportAnchor+A,hasMoreAbove:C,historyLoading:!1,historyLimit:l,historyComplete:!C,totalAvailableMessages:Math.max(f.totalAvailableMessages??0,y.length)}),{messages:D,sessionMemoryState:b}});return}}}finally{t(d=>{const g=d.sessionMemoryState.get(e);if(!g||!g.historyLoading)return d;const y=new Map(d.sessionMemoryState);return y.set(e,{...g,historyLoading:!1}),{sessionMemoryState:y}})}},getLastMessageModel:e=>{const{messages:s}=n(),r=s.get(e);if(!r||r.length===0)return null;for(let o=r.length-1;o>=0;o--){const a=r[o];if(a.info.role==="assistant"&&"providerID"in a.info&&"modelID"in a.info)return{providerID:a.info.providerID,modelID:a.info.modelID}}return null}}),{name:"message-store",storage:Ae(()=>de()),partialize:t=>({lastUsedProvider:t.lastUsedProvider,sessionMemoryState:Array.from(t.sessionMemoryState.entries()).map(([n,e])=>[n,{viewportAnchor:e.viewportAnchor,isStreaming:e.isStreaming,lastAccessedAt:e.lastAccessedAt,backgroundMessageCount:e.backgroundMessageCount,totalAvailableMessages:e.totalAvailableMessages,hasMoreAbove:e.hasMoreAbove,historyLoading:e.historyLoading,historyComplete:e.historyComplete,historyLimit:e.historyLimit,trimmedHeadMaxId:e.trimmedHeadMaxId}]),sessionAbortFlags:Array.from(t.sessionAbortFlags.entries()).map(([n,e])=>[n,{timestamp:e.timestamp,acknowledged:e.acknowledged}])}),merge:(t,n)=>{if(!t)return n;let e=n.sessionMemoryState;Array.isArray(t.sessionMemoryState)&&(e=new Map(t.sessionMemoryState.map(r=>{const[o,a]=r;return[o,{...a,hasMoreAbove:void 0,historyComplete:void 0,historyLimit:void 0,historyLoading:!1}]})));let s=n.sessionAbortFlags;return Array.isArray(t.sessionAbortFlags)&&(s=new Map(t.sessionAbortFlags)),{...n,lastUsedProvider:t.lastUsedProvider??n.lastUsedProvider,sessionMemoryState:e,sessionAbortFlags:s}}}),{name:"message-store"})),Ln=t=>typeof t=="object"&&t!==null,Bn=t=>{if(!Array.isArray(t))return[];const n=[];return t.forEach(e=>{if(!Array.isArray(e)||e.length!==2)return;const[s,r]=e;typeof s!="string"||!Array.isArray(r)||n.push([s,r])}),n},Wn=async(t,n)=>{try{const s=I.getState().getDirectoryForSession(t);if(s)return F.withDirectory(s,n)}catch(e){console.warn("Failed to resolve session directory for permission handling:",e)}return n()},qe=ue()(ge(we((t,n)=>({permissions:new Map,addPermission:(e,s)=>{const r=e.sessionID;if(!r||n().permissions.get(r)?.some(g=>g.id===e.id))return;const a=e.permission?.toLowerCase?.()??null;let i=s?.currentAgentContext?.get(r);if(i||(i=s?.sessionAgentSelections?.get(r)??void 0),!i&&typeof window<"u"){const g=window.__zustand_config_store__;g?.getState&&(i=g.getState().currentAgentName??void 0)}const c=$e(i),l=s?.getSessionAgentEditMode?.(r,i)??c;if((l==="allow"||l==="full")&&Cn(a)){n().respondToPermission(r,e.id,"once").catch(()=>{});return}t(g=>{const y=g.permissions.get(r)||[],m=new Map(g.permissions);return m.set(r,[...y,e]),{permissions:m}})},respondToPermission:async(e,s,r)=>{await Wn(e,()=>F.replyToPermission(s,r)),r==="reject"&&await B.getState().abortCurrentOperation(e),t(o=>{const i=(o.permissions.get(e)||[]).filter(l=>l.id!==s),c=new Map(o.permissions);return c.set(e,i),{permissions:c}})}}),{name:"permission-store",storage:Ae(()=>de()),partialize:t=>({permissions:Array.from(t.permissions.entries())}),merge:(t,n)=>{if(!Ln(t))return n;const e=Bn(t.permissions);return{...n,permissions:new Map(e)}}}),{name:"permission-store"})),Nn=t=>typeof t=="object"&&t!==null,$n=t=>{if(!Array.isArray(t))return[];const n=[];return t.forEach(e=>{if(!Array.isArray(e)||e.length!==2)return;const[s,r]=e;typeof s!="string"||!Array.isArray(r)||n.push([s,r])}),n},Lt=async(t,n)=>{try{const s=I.getState().getDirectoryForSession(t);if(s)return F.withDirectory(s,n)}catch(e){console.warn("Failed to resolve session directory for question handling:",e)}return n()},he=ue()(ge(we((t,n)=>({questions:new Map,addQuestion:e=>{const s=e.sessionID;!s||n().questions.get(s)?.some(o=>o.id===e.id)||t(o=>{const a=o.questions.get(s)||[],i=new Map(o.questions);return i.set(s,[...a,e]),{questions:i}})},dismissQuestion:(e,s)=>{!e||!s||t(r=>{const a=(r.questions.get(e)||[]).filter(c=>c.id!==s),i=new Map(r.questions);return i.set(e,a),{questions:i}})},respondToQuestion:async(e,s,r)=>{await Lt(e,()=>F.replyToQuestion(s,r)),n().dismissQuestion(e,s)},rejectQuestion:async(e,s)=>{await Lt(e,()=>F.rejectQuestion(s)),n().dismissQuestion(e,s)}}),{name:"question-store",storage:Ae(()=>de()),partialize:t=>({questions:Array.from(t.questions.entries())}),merge:(t,n)=>{if(!Nn(t))return n;const e=$n(t.questions);return{...n,questions:new Map(e)}}}),{name:"question-store"})),zn=t=>t.filter(s=>s?.type==="text").map(s=>(s.text||s.content||"").trim()).filter(s=>s.length>0).join(`
`).replace(/\n\s*\n+/g,`
`),_e=t=>{if(typeof t!="string")return null;const n=t.trim();if(!n)return null;const e=n.replace(/\\/g,"/");return e==="/"?"/":e.length>1?e.replace(/\/+$/,""):e},Bt=(t,n,e)=>{if(!n)return null;const s=e(n)?.path;if(typeof s=="string"&&s.trim().length>0)return _e(s);const r=t.find(o=>o.id===n);return r?_e(r.directory??null):null},Q=ue()(ge((t,n)=>({sessions:[],sessionsByDirectory:new Map,currentSessionId:null,lastLoadedDirectory:null,messages:new Map,sessionMemoryState:new Map,messageStreamStates:new Map,sessionCompactionUntil:new Map,sessionAbortFlags:new Map,permissions:new Map,questions:new Map,attachedFiles:[],isLoading:!1,error:null,streamingMessageIds:new Map,abortControllers:new Map,lastUsedProvider:null,isSyncing:!1,sessionModelSelections:new Map,sessionAgentSelections:new Map,sessionAgentModelSelections:new Map,webUICreatedSessions:new Set,worktreeMetadata:new Map,availableWorktrees:[],availableWorktreesByProject:new Map,currentAgentContext:new Map,sessionContextUsage:new Map,sessionAgentEditModes:new Map,abortPromptSessionId:null,abortPromptExpiresAt:null,sessionStatus:new Map,sessionAttentionStates:new Map,userSummaryTitles:new Map,pendingInputText:null,pendingInputMode:"replace",pendingSyntheticParts:null,newSessionDraft:{open:!0,directoryOverride:null,parentID:null},voiceStatus:"disconnected",voiceMode:"idle",setVoiceStatus:e=>{t({voiceStatus:e})},setVoiceMode:e=>{t({voiceMode:e})},getSessionAgentEditMode:(e,s,r)=>L.getState().getSessionAgentEditMode(e,s,r),toggleSessionAgentEditMode:(e,s,r)=>L.getState().toggleSessionAgentEditMode(e,s,r),setSessionAgentEditMode:(e,s,r,o)=>L.getState().setSessionAgentEditMode(e,s,r,o),loadSessions:()=>I.getState().loadSessions(),openNewSessionDraft:e=>{let s=null;e?.directoryOverride!==void 0?s=e.directoryOverride:s=at.getState().getActiveProject()?.path??null,t({newSessionDraft:{open:!0,directoryOverride:s,parentID:e?.parentID??null,title:e?.title,initialPrompt:e?.initialPrompt,syntheticParts:e?.syntheticParts},currentSessionId:null,error:null,...e?.initialPrompt?{pendingInputText:e.initialPrompt,pendingInputMode:"replace"}:{}});try{const r=ve.getState(),o=r.getVisibleAgents();let a;if(r.settingsDefaultAgent){const i=o.find(c=>c.name===r.settingsDefaultAgent);i&&(a=i.name)}a||(a=o.find(i=>i.name==="build")?.name||o[0]?.name),a&&r.setAgent(a)}catch{}},closeNewSessionDraft:()=>{const e=I.getState().currentSessionId;t({newSessionDraft:{open:!1,directoryOverride:null,parentID:null,title:void 0,initialPrompt:void 0,syntheticParts:void 0},currentSessionId:e})},createSession:async(e,s,r)=>{n().closeNewSessionDraft();const o=await I.getState().createSession(e,s,r);return o?.id&&await n().setCurrentSession(o.id),o},createSessionFromAssistantMessage:async e=>{if(!e)return;const s=B.getState(),{messages:r,lastUsedProvider:o}=s;let a,i;if(r.forEach((u,f)=>{const w=u.find(v=>v.info?.id===e);w&&!a&&(a=w,i=f)}),!a||a.info.role!=="assistant")return;const c=zn(a.parts);if(!c.trim())return;const l=I.getState(),d=Bt(l.sessions,i??null,l.getWorktreeMetadata),g=await n().createSession(void 0,d??null,null);if(!g)return;const{currentProviderId:y,currentModelId:m,currentAgentName:S}=ve.getState(),p=y||o?.providerID,h=m||o?.modelID;!p||!h||await F.sendMessage({id:g.id,providerID:p,modelID:h,text:c,prefaceText:ns,agent:S??void 0})},deleteSession:(e,s)=>I.getState().deleteSession(e,s),deleteSessions:(e,s)=>I.getState().deleteSessions(e,s),updateSessionTitle:(e,s)=>I.getState().updateSessionTitle(e,s),shareSession:e=>I.getState().shareSession(e),unshareSession:e=>I.getState().unshareSession(e),setCurrentSession:async e=>{e&&n().closeNewSessionDraft();const s=I.getState().currentSessionId,r=Bt(I.getState().sessions,e,I.getState().getWorktreeMetadata),o=F.getDirectory()??Pe.getState().currentDirectory??null,a=r??o;try{F.setDirectory(a??void 0)}catch(i){console.warn("Failed to set OpenCode directory for session switch:",i)}if(s&&s!==e&&!n().sessionMemoryState.get(s)?.isStreaming){const c=n().messages.get(s)||[];c.length>0&&n().updateViewportAnchor(s,c.length-1),n().trimToViewportWindow(s,lt())}if(I.getState().setCurrentSession(e),e){const i=n().messages.get(e),c=n().sessionMemoryState.get(e),l=!c||c.historyComplete===void 0;(!i||l)&&await n().loadMessages(e),n().trimToViewportWindow(e,ct());const d=n().messages.get(e);if(d&&d.length>0){const g=ve.getState().agents;if(g.length>0)try{await L.getState().analyzeAndSaveExternalSessionChoices(e,g,n().messages)}catch(y){console.warn("Failed to analyze session choices:",y)}}}n().evictLeastRecentlyUsed()},loadMessages:(e,s)=>B.getState().loadMessages(e,s),sendMessage:async(e,s,r,o,a,i,c,l)=>{const d=n().newSessionDraft,g=typeof o=="string"&&o.trim().length>0?o.trim():void 0,y=(u,f)=>{t(w=>{const v=new Map(w.sessionStatus??new Map);return v.set(u,{type:f}),{sessionStatus:v}})};if(d?.open){const u=await I.getState().createSession(d.title,d.directoryOverride??null,d.parentID??null);if(!u?.id)throw new Error("Failed to create session");const f=ve.getState(),w=f.currentAgentName,v=g??w,M=f.currentProviderId,A=f.currentModelId;if(M&&A)try{L.getState().saveSessionModelSelection(u.id,M,A)}catch{}if(v){try{L.getState().saveSessionAgentSelection(u.id,v)}catch{}if(M&&A){try{L.getState().saveAgentModelForSession(u.id,v,M,A)}catch{}if(l!==void 0)try{L.getState().saveAgentModelVariantForSession(u.id,v,M,A,l)}catch{}}}try{I.getState().initializeNewOpenChamberSession(u.id,f.agents)}catch{}const C=d.syntheticParts;n().closeNewSessionDraft(),y(u.id,"busy");const D=C?.length?[...c||[],...C]:c;try{return await B.getState().sendMessage(e,s,r,v,u.id,a,i,D,l)}catch(b){throw y(u.id,"idle"),b}}const m=I.getState().currentSessionId,S=m?L.getState().getSessionAgentSelection(m):null,p=ve.getState().currentAgentName,h=g||S||p||void 0;if(m&&h){try{L.getState().saveSessionAgentSelection(m,h)}catch{}if(l!==void 0)try{L.getState().saveAgentModelVariantForSession(m,h,s,r,l)}catch{}}if(m){y(m,"busy");const u=n().sessionMemoryState.get(m);if(!u||!u.lastUserMessageAt){const f=n().sessionMemoryState,w=new Map(f);w.set(m,{viewportAnchor:u?.viewportAnchor??0,isStreaming:u?.isStreaming??!1,lastAccessedAt:Date.now(),backgroundMessageCount:u?.backgroundMessageCount??0,lastUserMessageAt:Date.now()}),t({sessionMemoryState:w})}}m&&fetch(`/api/sessions/${m}/message-sent`,{method:"POST"}).catch(()=>{});try{return await B.getState().sendMessage(e,s,r,h,m||void 0,a,i,c,l)}catch(u){throw m&&y(m,"idle"),u}},abortCurrentOperation:()=>{const e=I.getState().currentSessionId;return B.getState().abortCurrentOperation(e||void 0)},armAbortPrompt:(e=3e3)=>{const s=I.getState().currentSessionId;if(!s)return null;const r=Date.now()+e;return t({abortPromptSessionId:s,abortPromptExpiresAt:r}),r},clearAbortPrompt:()=>{t({abortPromptSessionId:null,abortPromptExpiresAt:null})},acknowledgeSessionAbort:e=>{e&&B.getState().acknowledgeSessionAbort(e)},addStreamingPart:(e,s,r,o)=>{const i=I.getState().currentSessionId||e;return B.getState().addStreamingPart(e,s,r,o,i)},completeStreamingMessage:(e,s)=>B.getState().completeStreamingMessage(e,s),markMessageStreamSettled:e=>B.getState().markMessageStreamSettled(e),updateMessageInfo:(e,s,r)=>B.getState().updateMessageInfo(e,s,r),updateSessionCompaction:(e,s)=>B.getState().updateSessionCompaction(e,s??null),addPermission:e=>{const s={currentAgentContext:L.getState().currentAgentContext,sessionAgentSelections:L.getState().sessionAgentSelections,getSessionAgentEditMode:L.getState().getSessionAgentEditMode};return qe.getState().addPermission(e,s)},respondToPermission:(e,s,r)=>qe.getState().respondToPermission(e,s,r),addQuestion:e=>he.getState().addQuestion(e),dismissQuestion:(e,s)=>he.getState().dismissQuestion(e,s),respondToQuestion:(e,s,r)=>he.getState().respondToQuestion(e,s,r),rejectQuestion:(e,s)=>he.getState().rejectQuestion(e,s),clearError:()=>I.getState().clearError(),getSessionsByDirectory:e=>I.getState().getSessionsByDirectory(e),getDirectoryForSession:e=>I.getState().getDirectoryForSession(e),getLastMessageModel:e=>B.getState().getLastMessageModel(e),getCurrentAgent:e=>L.getState().getCurrentAgent(e),syncMessages:(e,s)=>B.getState().syncMessages(e,s),applySessionMetadata:(e,s)=>I.getState().applySessionMetadata(e,s),addAttachedFile:e=>ce.getState().addAttachedFile(e),addServerFile:(e,s,r)=>ce.getState().addServerFile(e,s,r),removeAttachedFile:e=>ce.getState().removeAttachedFile(e),clearAttachedFiles:()=>ce.getState().clearAttachedFiles(),updateViewportAnchor:(e,s)=>B.getState().updateViewportAnchor(e,s),trimToViewportWindow:(e,s)=>{const r=I.getState().currentSessionId,o=n().sessionStatus?.get(e);if(!(o?.type==="busy"||o?.type==="retry"))return B.getState().trimToViewportWindow(e,s,r||void 0)},evictLeastRecentlyUsed:()=>{const e=I.getState().currentSessionId;return B.getState().evictLeastRecentlyUsed(e||void 0)},loadMoreMessages:(e,s)=>B.getState().loadMoreMessages(e,s),saveSessionModelSelection:(e,s,r)=>L.getState().saveSessionModelSelection(e,s,r),getSessionModelSelection:e=>L.getState().getSessionModelSelection(e),saveSessionAgentSelection:(e,s)=>L.getState().saveSessionAgentSelection(e,s),getSessionAgentSelection:e=>L.getState().getSessionAgentSelection(e),saveAgentModelForSession:(e,s,r,o)=>L.getState().saveAgentModelForSession(e,s,r,o),getAgentModelForSession:(e,s)=>L.getState().getAgentModelForSession(e,s),saveAgentModelVariantForSession:(e,s,r,o,a)=>L.getState().saveAgentModelVariantForSession(e,s,r,o,a),getAgentModelVariantForSession:(e,s,r,o)=>L.getState().getAgentModelVariantForSession(e,s,r,o),analyzeAndSaveExternalSessionChoices:(e,s)=>{const r=B.getState().messages;return L.getState().analyzeAndSaveExternalSessionChoices(e,s,r)},isOpenChamberCreatedSession:e=>I.getState().isOpenChamberCreatedSession(e),markSessionAsOpenChamberCreated:e=>I.getState().markSessionAsOpenChamberCreated(e),initializeNewOpenChamberSession:(e,s)=>I.getState().initializeNewOpenChamberSession(e,s),setWorktreeMetadata:(e,s)=>I.getState().setWorktreeMetadata(e,s),setSessionDirectory:(e,s)=>I.getState().setSessionDirectory(e,s),getWorktreeMetadata:e=>I.getState().getWorktreeMetadata(e),getContextUsage:(e,s)=>{if(n().newSessionDraft?.open)return null;const r=I.getState().currentSessionId;if(!r)return null;const o=B.getState().messages;return L.getState().getContextUsage(r,e,s,o)},updateSessionContextUsage:(e,s,r)=>{const o=B.getState().messages;return L.getState().updateSessionContextUsage(e,s,r,o)},initializeSessionContextUsage:(e,s,r)=>{const o=B.getState().messages;return L.getState().initializeSessionContextUsage(e,s,r,o)},debugSessionMessages:async e=>{const s=B.getState().messages.get(e)||[],r=I.getState().sessions.find(o=>o.id===e);console.log(`Debug session ${e}:`,{session:r,messageCount:s.length,messages:s.map(o=>({id:o.info.id,role:o.info.role,parts:o.parts.length,tokens:o.info.tokens}))})},pollForTokenUpdates:(e,s,r)=>{const o=B.getState().messages;return L.getState().pollForTokenUpdates(e,s,o,r)},updateSession:e=>I.getState().updateSession(e),removeSessionFromStore:e=>I.getState().removeSessionFromStore(e),revertToMessage:async(e,s)=>{const o=(B.getState().messages.get(e)||[]).find(d=>d.info.id===s);let a="";o&&o.info.role==="user"&&(a=o.parts.filter(g=>g.type==="text").map(g=>{const y=g;return y.text||y.content||""}).join(`
`).trim());const i=await F.revertSession(e,s);I.getState().updateSession(i);const c=B.getState().messages.get(e)||[],l=i.revert?.messageID;if(l){const d=c.findIndex(g=>g.info.id===l);if(d!==-1){const g=c.slice(0,d);B.getState().syncMessages(e,g)}}a&&t({pendingInputText:a,pendingInputMode:"replace"})},handleSlashUndo:async e=>{const r=(n().messages.get(e)||[]).filter(y=>y.info.role==="user"),a=n().sessions.find(y=>y.id===e);if(r.length===0)return;const i=a?.revert?.messageID;let c;if(i){const y=r.findIndex(m=>m.info.id===i);c=r[y+1]}else c=r[r.length-1];if(!c)return;const l=c.parts.find(y=>y.type==="text"),d=typeof l=="object"&&l&&"text"in l?String(l.text).slice(0,50)+(String(l.text).length>50?"...":""):"[No text]";await n().revertToMessage(e,c.info.id);const{toast:g}=await oe(async()=>{const{toast:y}=await import("./index2.js").then(m=>m.i);return{toast:y}},__vite__mapDeps([0,1,2]),import.meta.url);g.success(`Undid to: ${d}`)},handleSlashRedo:async e=>{const o=n().sessions.find(d=>d.id===e)?.revert?.messageID;if(!o)return;const i=(n().messages.get(e)||[]).filter(d=>d.info.role==="user"),c=i.findIndex(d=>d.info.id===o),l=i[c-1];if(l){const d=l.parts.find(m=>m.type==="text"),g=typeof d=="object"&&d&&"text"in d?String(d.text).slice(0,50)+(String(d.text).length>50?"...":""):"[No text]";await n().revertToMessage(e,l.info.id);const{toast:y}=await oe(async()=>{const{toast:m}=await import("./index2.js").then(S=>S.i);return{toast:m}},__vite__mapDeps([0,1,2]),import.meta.url);y.success(`Redid to: ${g}`)}else{const d=await F.unrevertSession(e);await I.getState().updateSession(d),await n().loadMessages(e);const{toast:g}=await oe(async()=>{const{toast:y}=await import("./index2.js").then(m=>m.i);return{toast:y}},__vite__mapDeps([0,1,2]),import.meta.url);g.success("Restored all messages")}},forkFromMessage:async(e,s)=>{const o=n().sessions.find(a=>a.id===e);if(o)try{const a=await F.forkSession(e,s);if(!a||!a.id){const{toast:g}=await oe(async()=>{const{toast:y}=await import("./index2.js").then(m=>m.i);return{toast:y}},__vite__mapDeps([0,1,2]),import.meta.url);g.error("Failed to fork session");return}const c=(n().messages.get(e)||[]).find(g=>g.info.id===s);if(!c){const{toast:g}=await oe(async()=>{const{toast:y}=await import("./index2.js").then(m=>m.i);return{toast:y}},__vite__mapDeps([0,1,2]),import.meta.url);g.error("Message not found");return}let l="";for(const g of c.parts)g.type==="text"&&!g.synthetic&&!g.ignored&&(l+=g.text||"");n().setCurrentSession(a.id),l&&t({pendingInputText:l,pendingInputMode:"replace"}),await n().loadMessages(a.id);const{toast:d}=await oe(async()=>{const{toast:g}=await import("./index2.js").then(y=>y.i);return{toast:g}},__vite__mapDeps([0,1,2]),import.meta.url);d.success(`Forked from ${o.title}`)}catch(a){console.error("Failed to fork session:",a);const{toast:i}=await oe(async()=>{const{toast:c}=await import("./index2.js").then(l=>l.i);return{toast:c}},__vite__mapDeps([0,1,2]),import.meta.url);i.error("Failed to fork session")}},setPendingInputText:(e,s="replace")=>{t({pendingInputText:e,pendingInputMode:s})},consumePendingInputText:()=>{const e=n().pendingInputText,s=n().pendingInputMode;return e!==null&&t({pendingInputText:null,pendingInputMode:"replace"}),e===null?null:{text:e,mode:s}},setPendingSyntheticParts:e=>{t({pendingSyntheticParts:e})},consumePendingSyntheticParts:()=>{const e=n().pendingSyntheticParts;return e!==null&&t({pendingSyntheticParts:null}),e}}),{name:"composed-session-store"}));I.subscribe((t,n)=>{if(t.sessions===n.sessions&&t.sessionsByDirectory===n.sessionsByDirectory&&t.currentSessionId===n.currentSessionId&&t.lastLoadedDirectory===n.lastLoadedDirectory&&t.isLoading===n.isLoading&&t.error===n.error&&t.webUICreatedSessions===n.webUICreatedSessions&&t.worktreeMetadata===n.worktreeMetadata&&t.availableWorktrees===n.availableWorktrees&&t.availableWorktreesByProject===n.availableWorktreesByProject)return;const e=Q.getState().newSessionDraft?.open;Q.setState({sessions:t.sessions,sessionsByDirectory:t.sessionsByDirectory,currentSessionId:e?null:t.currentSessionId,lastLoadedDirectory:t.lastLoadedDirectory,isLoading:t.isLoading,error:t.error,webUICreatedSessions:t.webUICreatedSessions,worktreeMetadata:t.worktreeMetadata,availableWorktrees:t.availableWorktrees,availableWorktreesByProject:t.availableWorktreesByProject})});B.subscribe((t,n)=>{if(t.messages===n.messages&&t.sessionMemoryState===n.sessionMemoryState&&t.messageStreamStates===n.messageStreamStates&&t.sessionCompactionUntil===n.sessionCompactionUntil&&t.sessionAbortFlags===n.sessionAbortFlags&&t.streamingMessageIds===n.streamingMessageIds&&t.abortControllers===n.abortControllers&&t.lastUsedProvider===n.lastUsedProvider&&t.isSyncing===n.isSyncing)return;const e=new Map;t.messages.forEach((s,r)=>{if(!(!Array.isArray(s)||s.length===0))for(let o=s.length-1;o>=0;o-=1){const a=s[o];if(!a||!a.info)continue;const i=a.info;if(i.role==="user"){const c=i.summary?.title;if(typeof c=="string"){const l=c.trim();if(l.length>0){const d=i.time&&typeof i.time.created=="number"?i.time.created:null;e.set(r,{title:l,createdAt:d});break}}}}}),Q.setState({messages:t.messages,sessionMemoryState:t.sessionMemoryState,messageStreamStates:t.messageStreamStates,sessionCompactionUntil:t.sessionCompactionUntil,sessionAbortFlags:t.sessionAbortFlags,streamingMessageIds:t.streamingMessageIds,abortControllers:t.abortControllers,lastUsedProvider:t.lastUsedProvider,isSyncing:t.isSyncing,userSummaryTitles:e})});ce.subscribe((t,n)=>{t.attachedFiles!==n.attachedFiles&&Q.setState({attachedFiles:t.attachedFiles})});L.subscribe((t,n)=>{t.sessionModelSelections===n.sessionModelSelections&&t.sessionAgentSelections===n.sessionAgentSelections&&t.sessionAgentModelSelections===n.sessionAgentModelSelections&&t.currentAgentContext===n.currentAgentContext&&t.sessionContextUsage===n.sessionContextUsage&&t.sessionAgentEditModes===n.sessionAgentEditModes||Q.setState({sessionModelSelections:t.sessionModelSelections,sessionAgentSelections:t.sessionAgentSelections,sessionAgentModelSelections:t.sessionAgentModelSelections,currentAgentContext:t.currentAgentContext,sessionContextUsage:t.sessionContextUsage,sessionAgentEditModes:t.sessionAgentEditModes})});qe.subscribe((t,n)=>{t.permissions!==n.permissions&&Q.setState({permissions:t.permissions})});he.subscribe((t,n)=>{t.questions!==n.questions&&Q.setState({questions:t.questions})});Pe.subscribe((t,n)=>{const e=_e(t.currentDirectory??null),s=_e(n.currentDirectory??null);if(e===s)return;const r=Q.getState().newSessionDraft;if(!r?.open)return;const o=_e(r.directoryOverride);o&&o!==s||Q.setState(a=>({newSessionDraft:{...a.newSessionDraft,directoryOverride:e,parentID:null}}))});const Gn=Q.getState().newSessionDraft?.open;Q.setState({sessions:I.getState().sessions,currentSessionId:Gn?null:I.getState().currentSessionId,lastLoadedDirectory:I.getState().lastLoadedDirectory,isLoading:I.getState().isLoading,error:I.getState().error,webUICreatedSessions:I.getState().webUICreatedSessions,worktreeMetadata:I.getState().worktreeMetadata,availableWorktrees:I.getState().availableWorktrees,availableWorktreesByProject:I.getState().availableWorktreesByProject,messages:B.getState().messages,sessionMemoryState:B.getState().sessionMemoryState,messageStreamStates:B.getState().messageStreamStates,sessionCompactionUntil:B.getState().sessionCompactionUntil,sessionAbortFlags:B.getState().sessionAbortFlags,streamingMessageIds:B.getState().streamingMessageIds,abortControllers:B.getState().abortControllers,lastUsedProvider:B.getState().lastUsedProvider,isSyncing:B.getState().isSyncing,permissions:qe.getState().permissions,questions:he.getState().questions,attachedFiles:ce.getState().attachedFiles,sessionModelSelections:L.getState().sessionModelSelections,sessionAgentSelections:L.getState().sessionAgentSelections,sessionAgentModelSelections:L.getState().sessionAgentModelSelections,currentAgentContext:L.getState().currentAgentContext,sessionContextUsage:L.getState().sessionContextUsage,sessionAgentEditModes:L.getState().sessionAgentEditModes,abortPromptSessionId:null,abortPromptExpiresAt:null});typeof window<"u"&&(window.__zustand_session_store__=Q);const fr=Object.freeze(Object.defineProperty({__proto__:null,ACTIVE_SESSION_WINDOW:ms,MEMORY_LIMITS:We,useSessionStore:Q},Symbol.toStringTag,{value:"Module"}));export{Zn as A,wt as B,Kn as C,rr as D,Je as E,Qn as F,Jn as G,qe as H,Te as I,Xt as J,We as K,lt as L,mr as M,ct as N,Ys as O,pn as P,gr as Q,fr as R,qn as a,Nt as b,dr as c,Us as d,ir as e,Gs as f,or as g,L as h,B as i,nr as j,cr as k,Xs as l,I as m,ar as n,ce as o,zn as p,Mt as q,gn as r,lr as s,er as t,Q as u,ur as v,Yn as w,Xn as x,tr as y,sr as z};
